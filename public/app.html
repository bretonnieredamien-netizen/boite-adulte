<!DOCTYPE html>
<html lang="fr">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6366f1">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ta boite magique ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;500;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- VARIABLES --- */
        :root { --bg-1: #fff7ed; --bg-2: #fef9c3; --bg-3: #ede9fe; --bg-4: #fae8ff; --accent-color: #6366f1; --vis-1: #4f46e5; --vis-2: #9333ea; --vis-3: #db2777; }
        
        /* FOND ANIM√â */
        body { font-family: 'Lexend', sans-serif; background: linear-gradient(-45deg, var(--bg-1), var(--bg-2), var(--bg-3), var(--bg-4)); background-size: 400% 400%; animation: gradientBG 15s ease infinite; touch-action: none; overflow: hidden; min-height: 100vh; margin: 0; transition: background 3s ease; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* MODE HISTOIRE (BACKGROUND SOMBRE PERSISTANT) */
        body.story-mode {
            background: linear-gradient(180deg, #020617 0%, #1e1b4b 40%, #312e81 100%) !important;
            background-size: 100% 100%;
        }
        body.story-mode #starfield { opacity: 0.8; }
        body.story-mode .status-box { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        body.story-mode #status { color: #e0e7ff; opacity: 0.9; }
        body.story-mode .nav-home-btn { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.1); }
        body.story-mode .nav-home-btn svg { fill: #a5b4fc; }
        body.story-mode .logo-container svg { filter: drop-shadow(0 0 25px rgba(165, 180, 252, 0.6)); }

        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; transition: opacity 3s ease; }
        .hidden { display: none !important; }
        .content-layer { position: relative; z-index: 10; width: 100%; display: flex; flex-direction: column; align-items: center; opacity: 0; transition: opacity 1s ease-in; }
        .content-visible { opacity: 1 !important; }

        /* --- BOUTON MAISON --- */
        .nav-home-btn { position: absolute; top: 1.5rem; left: 1.5rem; z-index: 9999; width: 52px; height: 52px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(15px); border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1); transition: all 0.3s; }
        .nav-home-btn:hover { transform: scale(1.15) rotate(-10deg); background: rgba(255, 255, 255, 0.7); }
        .nav-home-btn svg { width: 26px; height: 26px; fill: var(--accent-color); }

        /* --- HEADER --- */
        #main-header { transition: opacity 1s ease, transform 1s ease; opacity: 1; transform: translateY(0); z-index: 50; }
        .cinema-mode { transform: translateY(-20px); }
        .logo-container { width: 180px; height: 180px; display: flex; justify-content: center; align-items: center; opacity: 0; animation: introFade 2s ease-out forwards; filter: drop-shadow(0 10px 25px rgba(129, 140, 248, 0.5)); transition: all 3s ease; }
        @keyframes introFade { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }

        /* --- VAGUES DE R√âFLEXION --- */
        .thinking-waves { display: flex; align-items: center; justify-content: center; gap: 4px; height: 24px; }
        .wave-bar { width: 6px; height: 100%; border-radius: 99px; animation: waveAnim 1s infinite ease-in-out; }
        .wave-bar:nth-child(1) { background: #a855f7; animation-delay: 0.0s; }
        .wave-bar:nth-child(2) { background: #6366f1; animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { background: #3b82f6; animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { background: #06b6d4; animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { background: #14b8a6; animation-delay: 0.4s; }
        @keyframes waveAnim { 0%, 100% { height: 20%; opacity: 0.5; } 50% { height: 100%; opacity: 1; transform: scaleY(1.1); } }

        /* --- ARDOISE & COLORIAGE --- */
        #slate-layer, #coloring-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; background: #0f172a; display: none; }
        #coloring-layer { background: #ffffff; }
        #slate-canvas, #color-canvas { width: 100%; height: 100%; cursor: crosshair; touch-action: none; position: absolute; top:0; left:0; z-index: 5; }
        
        #generated-coloring-image {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%; object-fit: contain;
            pointer-events: none; mix-blend-mode: multiply; z-index: 10; opacity: 1;
        }

        .slate-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 800px; display: flex; gap: 12px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); padding: 12px 20px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255, 255, 255, 0.2); align-items: center; z-index: 160; overflow-x: auto; justify-content: flex-start; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; }
        #coloring-controls { background: rgba(255, 255, 255, 0.95); border: 1px solid #cbd5e1; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .slate-controls::-webkit-scrollbar { display: none; } 
        
        .brush-btn { flex-shrink: 0; width: 48px; height: 48px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; transition: 0.2s; background: rgba(255,255,255,0.1); color: white; }
        #coloring-controls .brush-btn { background: #f1f5f9; color: #334155; border: 1px solid #e2e8f0; }
        .brush-btn.active { border-color: #6366f1; transform: scale(1.1); background: white; color: #1e293b; box-shadow: 0 0 15px rgba(99,102,241,0.5); }
        
        .color-picker { flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); cursor: pointer; transition: 0.2s; }
        #coloring-controls .color-picker { border: 2px solid #cbd5e1; }
        .color-picker.active { transform: scale(1.3); border-color: white; box-shadow: 0 0 10px white; }
        #coloring-controls .color-picker.active { border-color: #6366f1; box-shadow: 0 0 10px #6366f1; }

        .slate-action { flex-shrink: 0; padding: 0.6rem 1.2rem; border-radius: 12px; font-weight: 800; font-size: 0.75rem; color: white; text-transform: uppercase; letter-spacing: 0.05em; background: rgba(255,255,255,0.1); white-space: nowrap; }
        #coloring-controls .slate-action { background: #fee2e2; color: #ef4444; }

        /* --- UI ELEMENTS --- */
        .status-box { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 0.6rem 1.8rem; border-radius: 9999px; border: 1px solid rgba(255, 255, 255, 0.5); margin-top: 1rem; min-height: 44px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .understood-flash { animation: success-pulse 0.8s ease-out !important; background: rgba(16, 185, 129, 0.2) !important; border-color: #10b981 !important; }
        @keyframes success-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); box-shadow: 0 0 60px #10b981; } 100% { transform: scale(1); } }
        
        /* STORY CARD AVEC CADENAS */
        #story-card { background: transparent; overflow: hidden; display: flex; align-items: center; justify-content: center; width: 100%; max-width: 320px; height: 100px; filter: drop-shadow(0 4px 6px rgba(129, 140, 248, 0.3)); position: relative; z-index: 50; }
        #visualizer-canvas { width: 100%; height: 100%; }
        
        .orbe-base { position: relative; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; z-index: 50; }
        .orbe-base svg { width: 45px; height: 45px; fill: var(--accent-color); transition: fill 1s; }
        .mic-listening { background: rgba(255, 255, 255, 0.3) !important; box-shadow: 0 0 50px var(--accent-color) !important; transform: scale(1.1); }
        #btn-stop svg { fill: #f87171; }
        #stop-container.opacity-100 #btn-stop { background: rgba(248, 113, 113, 0.15); border-color: #f87171; box-shadow: 0 0 30px rgba(248, 113, 113, 0.4); }

        /* --- ACCUEIL --- */
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease-out, visibility 0.8s; }
        .mode-selector { display: flex; gap: 1.5rem; align-items: center; justify-content: center; width: 100%; flex-wrap: wrap; padding: 0 20px; max-width: 900px; }
        .mode-card { display: flex; flex-direction: column; align-items: center; gap: 0.8rem; cursor: pointer; transition: transform 0.3s ease; margin-bottom: 1rem; }
        .mode-card:hover { transform: scale(1.1); }
        .mode-icon-box { width: 90px; height: 90px; border-radius: 20px; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(20px); border: 2px solid rgba(255, 255, 255, 0.6); display: flex; align-items: center; justify-content: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .mode-label { font-weight: 800; color: rgba(79, 70, 229, 0.6); text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.7rem; }
        .god-rays { position: absolute; width: 180%; height: 180%; background: conic-gradient(from 0deg, transparent 0deg, rgba(251, 191, 36, 0.2) 20deg, transparent 40deg, rgba(139, 92, 246, 0.2) 60deg, transparent 80deg); border-radius: 50%; z-index: -1; opacity: 1; animation: spinRays 20s linear infinite; top: 50%; left: 50%; transform: translate(-50%, -50%); mix-blend-mode: overlay; pointer-events: none; }
        @keyframes spinRays { 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .intro-fade-out { opacity: 0; pointer-events: none; }
        .white-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 90; opacity: 0; pointer-events: none; }
        .flash-active { animation: flashAnim 1.5s ease-out forwards; }
        @keyframes flashAnim { 0% { opacity: 0; } 15% { opacity: 0.95; } 100% { opacity: 0; } }

        /* --- SPOTIFY PLAYER --- */
        #spotify-container { width: 100%; max-width: 400px; height: 0; overflow: hidden; transition: height 0.5s ease; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #spotify-container.active { height: 152px; margin-top: 20px; }
        iframe { border-radius: 12px; }
    </style>
</head>
<body class="p-6">

    <canvas id="starfield"></canvas>

    <div id="sleep-overlay" class="fixed top-0 left-0 w-full h-full bg-black z-[9999] hidden flex flex-col items-center justify-center text-white/20 select-none touch-none" ondblclick="desactiverModeSommeil()">
        <div class="text-4xl mb-4 opacity-50">üåô</div>
        <p class="text-xs font-medium uppercase tracking-widest">Double-tap pour r√©veiller</p>
    </div>

    <div id="slate-layer">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <canvas id="slate-canvas"></canvas>
        <div class="slate-controls">
            <div id="base-colors" class="flex gap-3 mr-2 border-r border-white/20 pr-4 flex-shrink-0">
                <div class="color-picker active" style="background:white" onclick="setBaseColor('white', this)"></div>
                <div class="color-picker" style="background:#ef4444" onclick="setBaseColor('#ef4444', this)"></div>
                <div class="color-picker" style="background:#3b82f6" onclick="setBaseColor('#3b82f6', this)"></div>
                <div class="color-picker" style="background:#22c55e" onclick="setBaseColor('#22c55e', this)"></div>
            </div>
            <button class="brush-btn active" onclick="setBrush('base', this)">‚úèÔ∏è</button>
            <button class="brush-btn" onclick="setBrush('neon', this)">üí°</button>
            <button class="brush-btn" onclick="setBrush('rainbow', this)">üåà</button>
            <button class="brush-btn" onclick="setBrush('fire', this)">üî•</button>
            <button class="brush-btn" onclick="setBrush('ice', this)">‚ùÑÔ∏è</button>
            <button class="brush-btn" onclick="setBrush('electric', this)">‚ö°</button>
            <button class="brush-btn" onclick="setBrush('galaxy', this)">üåå</button>
            <button class="brush-btn" onclick="setBrush('gold', this)">‚ú®</button>
            <div class="w-px h-8 bg-white/20 mx-2 flex-shrink-0"></div>
            <button class="brush-btn" onclick="setBrush('eraser', this)">üßΩ</button>
            <button onclick="clearSlate()" class="slate-action">Effacer</button>
        </div>
    </div>

    <div id="coloring-layer">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <img id="generated-coloring-image" src="" alt="" style="display:none;">
        <canvas id="color-canvas"></canvas>
        <div id="coloring-controls" class="slate-controls">
            <div class="flex gap-3 mr-4 flex-shrink-0">
                <div class="color-picker active" style="background:#ef4444" onclick="setColoringColor('#ef4444', this)"></div>
                <div class="color-picker" style="background:#f97316" onclick="setColoringColor('#f97316', this)"></div>
                <div class="color-picker" style="background:#eab308" onclick="setColoringColor('#eab308', this)"></div>
                <div class="color-picker" style="background:#22c55e" onclick="setColoringColor('#22c55e', this)"></div>
                <div class="color-picker" style="background:#3b82f6" onclick="setColoringColor('#3b82f6', this)"></div>
                <div class="color-picker" style="background:#a855f7" onclick="setColoringColor('#a855f7', this)"></div>
                <div class="color-picker" style="background:#ec4899" onclick="setColoringColor('#ec4899', this)"></div>
                <div class="color-picker" style="background:#78350f" onclick="setColoringColor('#78350f', this)"></div>
                <div class="color-picker" style="background:#000000" onclick="setColoringColor('#000000', this)"></div>
            </div>
            <button class="brush-btn active" onclick="setColoringBrush('marker', this)" title="Feutre">üñçÔ∏è</button>
            <button class="brush-btn" onclick="setColoringBrush('crayon', this)" title="Crayon">‚úèÔ∏è</button>
            <div class="w-px h-8 bg-gray-300 mx-2 flex-shrink-0"></div>
            <button class="brush-btn" onclick="setColoringBrush('eraser', this)">üßΩ</button>
            <button onclick="clearColoring()" class="slate-action">Nouveau</button>
        </div>
    </div>

    <div id="intro-overlay">
        <div class="god-rays"></div>
        
        <div class="flex flex-col items-center gap-2 mb-10 transform scale-125">
            <svg class="h-16 w-16 drop-shadow-md" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="5" y="5" width="90" height="90" rx="25" fill="url(#logo_grad_intro)" />
                <path d="M30 50 Q30 30 50 30 Q70 30 70 50 Q70 70 50 70 L35 80 L35 70 Q30 70 30 50" fill="white"/>
                <path d="M65 35 L70 25 L75 35 L85 40 L75 45 L70 55 L65 45 L55 40 Z" fill="#fcd34d"/>
                <defs>
                    <linearGradient id="logo_grad_intro" x1="0" y1="0" x2="100" y2="100">
                        <stop offset="0%" stop-color="#6366f1"/>
                        <stop offset="100%" stop-color="#ec4899"/>
                    </linearGradient>
                </defs>
            </svg>
            <div class="flex flex-col items-center">
                <span class="font-black text-lg tracking-tight text-slate-900 leading-none">Mes petites boites</span>
                <span class="font-black text-xl tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-pink-500 leading-none">magiques</span>
            </div>
        </div>

        <div class="mode-selector">
            <div class="mode-card" onclick="selectMode('STORY')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#6366f1"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg></div>
                <span class="mode-label">Histoires</span>
            </div>
            <div class="mode-card" onclick="selectMode('QUESTION')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#ec4899"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg></div>
                <span class="mode-label">Questions</span>
            </div>
            <div class="mode-card" onclick="selectMode('CHAT')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#f59e0b"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></div>
                <span class="mode-label">Discussion</span>
            </div>
            <div class="mode-card" onclick="selectMode('DRAW')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#10b981"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8z"/></svg></div>
                <span class="mode-label">Dessin</span>
            </div>
            
            </div>
        <button onclick="oublierTout()" class="mt-8 text-indigo-900/40 text-xs font-bold uppercase tracking-widest hover:text-indigo-600 transition-colors">Red√©finir mon profil</button>
    </div>

    <div id="white-flash" class="white-flash"></div>

    <div id="main-interface" class="content-layer min-h-screen">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>

        <header id="main-header" class="text-center flex flex-col items-center mt-6">
            <div class="logo-container">
                <svg id="main-logo-story" class="hidden" viewBox="0 0 24 24" fill="#6366f1" width="100" height="100"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                <svg id="main-logo-question" class="hidden" viewBox="0 0 24 24" fill="#ec4899" width="100" height="100"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>
                <svg id="main-logo-chat" class="hidden" viewBox="0 0 24 24" fill="#f59e0b" width="100" height="100"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                <svg id="main-logo-coloring" class="hidden" viewBox="0 0 24 24" fill="#8b5cf6" width="100" height="100"><path d="M17.75 7L14 3.25l-10 10V17h3.75l10-10zm2.96-2.96c.39-.39.39-1.02 0-1.41L18.37.29c-.39-.39-1.02-.39-1.41 0L15.5 1.75l2.75 2.75 1.46-1.46z"/></svg>
                <svg id="main-logo-music" class="hidden" viewBox="0 0 24 24" fill="#06b6d4" width="100" height="100"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>
            <div class="status-box">
                <p id="status" class="text-indigo-900/60 font-semibold italic text-sm">Pr√™t...</p>
                <div id="ai-thinking" class="hidden thinking-waves">
                    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                </div>
            </div>
        </header>

        <main class="w-full max-w-md flex flex-col items-center gap-14 mt-8">
            <div class="flex items-center justify-center gap-12 w-full">
                <button id="btn-mic" class="orbe-base shadow-2xl">
                    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                </button>
                <div id="stop-container" class="opacity-20 pointer-events-none transition-all duration-500">
                    <button id="btn-stop" class="orbe-base shadow-xl"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2" /></svg></button>
                </div>
            </div>
            
            <div id="story-card" class="hidden transition-all duration-500 relative">
                <button onclick="activerModeSommeil()" class="absolute top-2 right-2 z-50 p-2 opacity-60 hover:opacity-100 transition-opacity" title="√âteindre l'√©cran (Mode Sommeil)">
                    <svg class="w-6 h-6 text-white drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </button>
                <canvas id="visualizer-canvas"></canvas>
            </div>

            <div id="spotify-container" class=""><iframe id="spotify-frame" style="border-radius:12px" src="" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe></div>
            <input type="text" id="manualInput" class="hidden">
        </main>
    </div>

    <script>
        // --- 1. S√âCURIT√â ABONNEMENT ---
        const urlParams = new URLSearchParams(window.location.search);
        const hasSessionId = urlParams.has('session_id');
        const isAlreadySubscribed = localStorage.getItem('BOITE_ABONNEMENT_ACTIF') === 'true';

        if (hasSessionId) {
            localStorage.setItem('BOITE_ABONNEMENT_ACTIF', 'true');
            window.history.replaceState({}, document.title, "/app.html");
        } else if (!isAlreadySubscribed) {
            window.location.href = "/";
        }

        let userPrenom = localStorage.getItem('BOITE_PRENOM');
        let userAge = localStorage.getItem('BOITE_AGE');
        let userGenre = localStorage.getItem('BOITE_GENRE'); 
        let userColor = localStorage.getItem('BOITE_COLOR'); 
        let userDoudou = localStorage.getItem('BOITE_DOUDOU');
        let userPet = localStorage.getItem('BOITE_ANIMAL'); 
        
        let currentAppMode = null; 
        let interactionMode = 'INIT'; 
        let chatHistory = []; 
        let isWaitingForResponse = false;
        
        // NOUVEAU : Gestion des sous-modes de discussion
        let currentChatActivity = 'TALK'; // 'TALK', 'JOKE', 'RIDDLE'

        /* --- GESTION DU MODE SOMMEIL (AM√âLIOR√â) --- */
        let wakeLock = null;

        async function activerModeSommeil() {
            const overlay = document.getElementById('sleep-overlay');
            overlay.classList.remove('hidden');
            
            // 1. On emp√™che le t√©l√©phone de s'√©teindre (WakeLock)
            try { 
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.log("WakeLock non support√©"); }

            // 2. On passe en PLEIN √âCRAN pour cacher l'heure et les boutons
            try {
                if (document.documentElement.requestFullscreen) {
                    await document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) { /* Safari */
                    await document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) { /* IE11 */
                    await document.documentElement.msRequestFullscreen();
                }
            } catch (err) { console.log("Plein √©cran refus√©"); }
        }

        async function desactiverModeSommeil() {
            const overlay = document.getElementById('sleep-overlay');
            overlay.classList.add('hidden');

            // 1. On rel√¢che le WakeLock
            if (wakeLock !== null) { 
                wakeLock.release().then(() => { wakeLock = null; }).catch(e => {}); 
            }

            // 2. On quitte le plein √©cran pour retrouver l'interface normale
            try {
                if (document.exitFullscreen) {
                    await document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { 
                    await document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { 
                    await document.msExitFullscreen();
                }
            } catch (err) { console.log("Erreur sortie plein √©cran"); }
        }

        // PHRASES MAGIQUES (Bienveillantes et sans "Chut")
        const MAGIC_PHRASES = [
            "Attends un tout petit instant, je suis en train de traverser la for√™t des r√™ves pour trouver la fin de ton histoire...",
            "Patiente un tout petit peu... Je demande aux √©toiles de me souffler la suite de ton aventure...",
            "Hop l√† ! Ouvre grand tes oreilles, je m√©lange de la poussi√®re de f√©e avec tes jolis mots...",
            "Un petit moment s'il te pla√Æt... Je cherche dans mon grand livre magique les mots les plus doux pour toi...",
            "Attends... Je suis en train de r√©veiller doucement les personnages de ton histoire, ils arrivent...",
            "Je demande doucement √† la lune de m'√©clairer pour inventer la plus belle des aventures...",
            "Juste une seconde... Je suis en train de peindre le ciel de ton histoire avec mes crayons de lumi√®re...",
            "Patiente encore un peu... Je suis partie chercher une id√©e merveilleuse tout l√†-haut dans les nuages...",
            "Attends, ne bouge pas... Je capture un rayon de soleil pour illuminer ton histoire...",
            "Hop ! Je suis en train de tricoter la suite de ton aventure avec des fils d'or et d'argent...",
            "Un instant... Je souffle sur les nuages pour voir appara√Ætre ton histoire...",
            "√âcoute bien... Je suis en train de chuchoter √† l'oreille des lutins pour qu'ils m'aident...",
            "Attends un peu... Je gonfle les voiles du bateau imaginaire pour nous emmener loin...",
            "Patiente... J'ouvre mon grand coffre aux tr√©sors pour y trouver ton histoire...",
            "Hop l√† ! Je saute de nuage en nuage pour attraper la suite de l'aventure...",
            "Juste un moment... Je plante une petite graine magique qui va devenir une grande histoire...",
            "Attends... Je mets mon chapeau de magicienne pour inventer quelque chose d'extraordinaire...",
            "Regarde... Je suis en train de rattraper une id√©e qui vole tr√®s vite dans le ciel...",
            "Un petit instant... Je pr√©pare une surprise incroyable rien que pour toi...",
            "Patiente... Je cherche la cl√© dor√©e qui ouvre la porte de ton histoire..."
        ];

        // PHRASES DE D√âBUT D'HISTOIRE (Rempla√ßant "Je te r√©ponds")
        const STORY_START_PHRASES = [
            "Ouvre grand tes oreilles, c'est parti !",
            "C'est parti pour l'aventure...",
            "Il √©tait une fois...",
            "Le rideau se l√®ve, √©coute bien...",
            "Plongeons ensemble dans cette histoire...",
            "Voici ce que le livre magique me raconte...",
            "Tu es pr√™t ? Alors on y va !",
            "Chut, l'histoire commence...",
            "Laisse-toi emporter par la magie...",
            "Regarde, le monde imaginaire s'ouvre √† toi...",
            "C'est l'heure du conte...",
            "Tout commence maintenant...",
            "Une nouvelle aventure t'attend...",
            "√âcoute le murmure de la magie...",
            "C'est le d√©but d'une belle histoire...",
            "Installe-toi bien, on d√©colle !",
            "La magie des mots commence ici...",
            "Voici l'histoire que j'ai invent√©e pour toi...",
            "Ferme les yeux et imagine...",
            "Le voyage commence maintenant...",
            "C'est une histoire tr√®s sp√©ciale...",
            "Pr√™t pour le voyage ? C'est parti !"
        ];

        /* --- DISCOTH√àQUE G√âANTE SPOTIFY (PLAYLISTS & GENRES) --- */
        const SPOTIFY_DB = {
            'POP': '37i9dQZF1DXcBWIGoYBM5M',     'DISNEY': '37i9dQZF1DX8C9xQcOrE6T',  'FILM': '37i9dQZF1DX8C9xQcOrE6T',    'VOITURE': '37i9dQZF1DWWHQM6sW8kDQ',
            'GUITARE': '37i9dQZF1DWZK4p8GZlQhW', 'GUITARE_ELEC': '37i9dQZF1DWWzBc3TOlaAV', 'PIANO': '37i9dQZF1DWUvHZA1zLcjW',   'VIOLON': '37i9dQZF1DWV7EzJMK2FUI',  'BATTERIE': '37i9dQZF1DWXJKyK5MgDWz', 'TROMPETTE': '37i9dQZF1DX6f3J34J8j5p',
            'ROCK': '37i9dQZF1DWWzBc3TOlaAV',    'METAL': '37i9dQZF1DX9qNs32fujYe',   'RAP': '37i9dQZF1DX0XUsuxWHRQd',     'JAZZ': '37i9dQZF1DXbITWG1ZJKYt',    'CLASSIQUE': '37i9dQZF1DWUvHZA1zLcjW', 'COUNTRY': '37i9dQZF1DX1lVhptIYRda', 'DISCO': '37i9dQZF1DX4UtSsGT1Sbe',
            'DODO': '37i9dQZF1DWZd79rJ6a7lp',    'CALME': '37i9dQZF1DWZd79rJ6a7lp',   'FETE': '37i9dQZF1DX2sUQqwWQbJn',    'DANSE': '37i9dQZF1DX2sUQqwWQbJn',   'TRISTE': '37i9dQZF1DX3YSRoSdA634',  'HEUREUX': '37i9dQZF1DXdPec7aLTmlC', 'SPORT': '37i9dQZF1DX76Wlfdnj7AP',
            'DINOSAURE': '37i9dQZF1DWWHQX5fP7a70', 'SUPERHEROS': '37i9dQZF1DXu2W0Mf8a55a', 'JEUXVIDEO': '37i9dQZF1DXdfOcg1fm0VG',  'HALLOWEEN': '37i9dQZF1EIdR77n0lqY6P',  'NOEL': '37i9dQZF1DX0A8zVl7p82B',
            'PLUIE': '37i9dQZF1DX8gym7ONOGCa',    'OCEAN': '37i9dQZF1DX4PP3kddpbma',    'FORET': '37i9dQZF1DWX83CujKHHbD',    'ANIMAUX': '37i9dQZF1DWWHQX5fP7a70',  'JUNGLE': '37i9dQZF1DWWHQX5fP7a70'
        };

        /* --- ARDOISE NOIRE --- */
        const sCanvas = document.getElementById('slate-canvas'); const sCtx = sCanvas.getContext('2d');
        let drawing = false, currentBrush = 'base', hue = 0, baseColor = 'white';
        function initSlate() { sCanvas.width = window.innerWidth; sCanvas.height = window.innerHeight; sCtx.lineCap = 'round'; sCtx.lineJoin = 'round'; }
        function setBrush(b, btn) { currentBrush = b; document.querySelectorAll('.brush-btn').forEach(el => el.classList.remove('active')); btn.classList.add('active'); }
        function setBaseColor(c, btn) { baseColor = c; currentBrush = 'base'; document.querySelectorAll('.color-picker').forEach(el => el.classList.remove('active')); btn.classList.add('active'); document.querySelectorAll('.brush-btn').forEach(el => el.classList.remove('active')); document.querySelector('.brush-btn[onclick*="base"]').classList.add('active'); }
        function draw(e) { if (!drawing) return; const x = e.clientX || e.touches[0].clientX; const y = e.clientY || e.touches[0].clientY; hue = (hue + 2) % 360; sCtx.lineWidth = currentBrush === 'galaxy' ? 1.5 : (currentBrush === 'neon' ? 3 : (currentBrush === 'eraser' ? 20 : 2.5)); sCtx.globalCompositeOperation = 'source-over'; 
            if (currentBrush === 'base') { sCtx.strokeStyle = baseColor; sCtx.shadowBlur = 0; } else if (currentBrush === 'eraser') { sCtx.globalCompositeOperation = 'destination-out'; sCtx.strokeStyle = 'rgba(0,0,0,1)'; sCtx.shadowBlur = 0; } else if (currentBrush === 'neon') { sCtx.strokeStyle = `hsl(${hue}, 100%, 70%)`; sCtx.shadowBlur = 15; sCtx.shadowColor = sCtx.strokeStyle; } else if (currentBrush === 'rainbow') { sCtx.strokeStyle = `hsl(${hue}, 100%, 50%)`; sCtx.shadowBlur = 0; } else if (currentBrush === 'lava') { sCtx.strokeStyle = `hsl(${Math.random() * 40}, 100%, 60%)`; sCtx.shadowBlur = 15; sCtx.shadowColor = '#ff4500'; for(let i=0; i<2; i++) { const pX = x + (Math.random()-0.5) * 15; const pY = y - Math.random() * 25; sCtx.fillStyle = `rgba(255, ${Math.floor(Math.random()*150)}, 0, 0.7)`; sCtx.beginPath(); sCtx.arc(pX, pY, Math.random()*2, 0, Math.PI*2); sCtx.fill(); } } else if (currentBrush === 'ice') { sCtx.strokeStyle = `rgba(224, 242, 254, 0.9)`; sCtx.shadowBlur = 10; sCtx.shadowColor = '#0ea5e9'; for(let i=0; i<2; i++) { const pX = x + (Math.random()-0.5) * 15; const pY = y + Math.random() * 25; sCtx.fillStyle = `rgba(255, 255, 255, 0.8)`; sCtx.beginPath(); sCtx.arc(pX, pY, Math.random()*1.5, 0, Math.PI*2); sCtx.fill(); } } else if (currentBrush === 'electric') { sCtx.strokeStyle = '#fef08a'; sCtx.shadowBlur = 20; sCtx.shadowColor = '#facc15'; const jitterX = x + (Math.random()-0.5) * 10; const jitterY = y + (Math.random()-0.5) * 10; sCtx.lineTo(jitterX, jitterY); } else if (currentBrush === 'galaxy') { sCtx.strokeStyle = 'rgba(255,255,255,0.8)'; sCtx.shadowBlur = 8; sCtx.shadowColor = `hsl(${hue}, 100%, 80%)`; for(let i=0; i<3; i++) { sCtx.beginPath(); sCtx.arc(x + (Math.random()-0.5)*20, y + (Math.random()-0.5)*20, Math.random()*1.5, 0, Math.PI*2); sCtx.fillStyle = 'white'; sCtx.fill(); } } else if (currentBrush === 'nature') { sCtx.strokeStyle = `hsl(120, 60%, 40%)`; sCtx.shadowBlur = 5; sCtx.shadowColor = '#166534'; for(let i=0; i<1; i++) { const pX = x + (Math.random()-0.5) * 20; const pY = y + (Math.random()-0.5) * 20; sCtx.fillStyle = `rgba(34, 197, 94, 0.8)`; sCtx.beginPath(); sCtx.ellipse(pX, pY, 3, 6, Math.random()*Math.PI, 0, Math.PI*2); sCtx.fill(); } } else if (currentBrush === 'ocean') { sCtx.strokeStyle = `hsl(200, 80%, 50%)`; sCtx.shadowBlur = 10; sCtx.shadowColor = '#0284c7'; for(let i=0; i<1; i++) { const pX = x + (Math.random()-0.5) * 15; const pY = y - Math.random() * 20; sCtx.strokeStyle = `rgba(255, 255, 255, 0.6)`; sCtx.beginPath(); sCtx.arc(pX, pY, Math.random()*3, 0, Math.PI*2); sCtx.stroke(); } sCtx.strokeStyle = `hsl(200, 80%, 50%)`; } else if (currentBrush === 'gold') { sCtx.strokeStyle = '#fbbf24'; sCtx.shadowBlur = 20; sCtx.shadowColor = '#f59e0b'; if(Math.random() > 0.8) { const pX = x + (Math.random()-0.5) * 20; const pY = y + (Math.random()-0.5) * 20; sCtx.fillStyle = '#fffbeb'; sCtx.beginPath(); sCtx.arc(pX, pY, Math.random()*2, 0, Math.PI*2); sCtx.fill(); } } else if (currentBrush === 'candy') { sCtx.strokeStyle = '#f472b6'; sCtx.shadowBlur = 5; sCtx.shadowColor = '#ec4899'; for(let i=0; i<2; i++) { const pX = x + (Math.random()-0.5) * 20; const pY = y + (Math.random()-0.5) * 20; sCtx.fillStyle = `hsl(${Math.random()*360}, 100%, 75%)`; sCtx.beginPath(); sCtx.arc(pX, pY, Math.random()*2.5, 0, Math.PI*2); sCtx.fill(); } }
            if (currentBrush !== 'electric') sCtx.lineTo(x, y); sCtx.stroke(); sCtx.beginPath(); sCtx.moveTo(x, y);
        }
        sCanvas.addEventListener('mousedown', (e) => { drawing = true; sCtx.beginPath(); sCtx.moveTo(e.clientX, e.clientY); }); sCanvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', () => drawing = false); sCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); drawing = true; sCtx.beginPath(); sCtx.moveTo(e.touches[0].clientX, e.touches[0].clientY); }); sCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }); window.addEventListener('touchend', () => drawing = false);
        function clearSlate() { sCtx.clearRect(0,0,sCanvas.width, sCanvas.height); }

        /* --- COLORIAGE --- */
        const cCanvas = document.getElementById('color-canvas'); const cCtx = cCanvas.getContext('2d');
        let coloring = false, cColor = '#ef4444', cBrush = 'marker';
        function initColoring() { cCanvas.width = window.innerWidth; cCanvas.height = window.innerHeight; cCtx.lineCap = 'round'; cCtx.lineJoin = 'round'; }
        function setColoringColor(c, btn) { cColor = c; cBrush = 'marker'; document.querySelectorAll('#coloring-controls .color-picker').forEach(el => el.classList.remove('active')); btn.classList.add('active'); document.querySelectorAll('#coloring-controls .brush-btn').forEach(el => el.classList.remove('active')); document.querySelector('#coloring-controls .brush-btn[onclick*="marker"]').classList.add('active'); }
        function setColoringBrush(b, btn) { cBrush = b; document.querySelectorAll('#coloring-controls .brush-btn').forEach(el => el.classList.remove('active')); btn.classList.add('active'); }
        function drawColor(e) { if (!coloring) return; const x = e.clientX || e.touches[0].clientX; const y = e.clientY || e.touches[0].clientY; 
            cCtx.strokeStyle = cColor; cCtx.globalCompositeOperation = 'source-over';
            if (cBrush === 'marker') { cCtx.lineWidth = 15; cCtx.globalAlpha = 0.5; } 
            else if (cBrush === 'crayon') { cCtx.lineWidth = 5; cCtx.globalAlpha = 1; }
            else if (cBrush === 'eraser') { cCtx.globalCompositeOperation = 'destination-out'; cCtx.lineWidth = 30; cCtx.globalAlpha = 1; }
            cCtx.lineTo(x, y); cCtx.stroke(); cCtx.beginPath(); cCtx.moveTo(x, y);
        }
        cCanvas.addEventListener('mousedown', (e) => { coloring = true; cCtx.beginPath(); cCtx.moveTo(e.clientX, e.clientY); }); cCanvas.addEventListener('mousemove', drawColor); window.addEventListener('mouseup', () => coloring = false); cCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); coloring = true; cCtx.beginPath(); cCtx.moveTo(e.touches[0].clientX, e.touches[0].clientY); }); cCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); drawColor(e); }); window.addEventListener('touchend', () => coloring = false);
        
        function clearColoring() { 
            cCtx.clearRect(0,0,cCanvas.width, cCanvas.height); 
            document.getElementById('generated-coloring-image').style.display = 'none';
            document.getElementById('coloring-layer').style.display = 'none';
            document.getElementById('main-interface').classList.add('content-visible');
            interactionMode = 'COLORING_INPUT'; 
            document.getElementById('status').innerText = "Une autre id√©e ?";
            speechQueue.push("D'accord, on change ! Que veux-tu colorier maintenant ?"); 
            parler();
        }

        async function genererColoriage(sujet) {
            const encoded = encodeURIComponent(`coloring page for kids, simple line art, black and white, white background, high contrast, ${sujet}`);
            const url = `https://image.pollinations.ai/prompt/${encoded}?width=1024&height=1024&nologo=true&seed=${Math.floor(Math.random()*9999)}`;
            
            const img = document.getElementById('generated-coloring-image');
            img.onload = () => {
                document.getElementById('ai-thinking').classList.add('hidden');
                document.getElementById('status').innerText = "√Ä tes crayons !";
                img.style.display = 'block';
                speechQueue.push("Et voil√† ton coloriage ! Tu peux dessiner dessus maintenant."); parler();
            };
            img.src = url;
        }

        function returnToMenu() {
            stopAudio();
            document.body.classList.remove('story-mode'); // D√âSACTIVE LE MODE SOMMEIL
            document.getElementById('slate-layer').style.display = 'none';
            document.getElementById('coloring-layer').style.display = 'none';
            document.getElementById('main-interface').classList.remove('content-visible');
            document.getElementById('main-logo-story').classList.add('hidden');
            document.getElementById('main-logo-question').classList.add('hidden');
            document.getElementById('main-logo-chat').classList.add('hidden');
            document.getElementById('main-logo-coloring').classList.add('hidden');
            document.getElementById('main-logo-music').classList.add('hidden');
            document.getElementById('intro-overlay').style.display = 'flex';
            document.getElementById('spotify-container').classList.remove('active');
            document.getElementById('spotify-frame').src = "";
            setTimeout(() => { document.getElementById('intro-overlay').classList.remove('intro-fade-out'); }, 50);
        }

        /* --- THEMES --- */
        const THEMES = { 'defaut': { bg: ['#fff7ed', '#fef9c3', '#ede9fe', '#fae8ff'], star: '251, 191, 36', accent: '#6366f1', vis: ['#4f46e5', '#9333ea', '#db2777'] }, 'bleu': { bg: ['#eff6ff', '#dbeafe', '#bfdbfe', '#93c5fd'], star: '96, 165, 250', accent: '#2563eb', vis: ['#1e40af', '#3b82f6', '#93c5fd'] }, 'rose': { bg: ['#fff1f2', '#ffe4e6', '#fecdd3', '#fda4af'], star: '244, 114, 182', accent: '#db2777', vis: ['#9d174d', '#db2777', '#f472b6'] }, 'rouge': { bg: ['#fef2f2', '#fee2e2', '#fecaca', '#fca5a5'], star: '248, 113, 113', accent: '#dc2626', vis: ['#991b1b', '#ef4444', '#f87171'] }, 'vert': { bg: ['#f0fdf4', '#dcfce7', '#bbf7d0', '#86efac'], star: '74, 222, 128', accent: '#16a34a', vis: ['#166534', '#22c55e', '#86efac'] }, 'violet': { bg: ['#f5f3ff', '#ede9fe', '#ddd6fe', '#c4b5fd'], star: '167, 139, 250', accent: '#7c3aed', vis: ['#5b21b6', '#8b5cf6', '#c4b5fd'] }, 'jaune': { bg: ['#fefce8', '#fef9c3', '#fef08a', '#fde047'], star: '234, 179, 8', accent: '#ca8a04', vis: ['#854d0e', '#eab308', '#fef08a'] }, 'sombre': { bg: ['#1e1b4b', '#312e81', '#4338ca', '#3730a3'], star: '255, 255, 255', accent: '#818cf8', vis: ['#4338ca', '#6366f1', '#a5b4fc'] } };
        const KEYWORDS = { 'bleu': 'bleu', 'mer': 'bleu', 'ciel': 'bleu', 'azur': 'bleu', 'rose': 'rose', 'f√©e': 'rose', 'princesse': 'rose', 'rouge': 'rouge', 'feu': 'rouge', 'pompier': 'rouge', 'vert': 'vert', 'nature': 'vert', 'foret': 'vert', 'herbe': 'vert', 'violet': 'violet', 'lilas': 'violet', 'mauve': 'violet', 'jaune': 'jaune', 'soleil': 'jaune', 'or': 'jaune', 'noir': 'sombre', 'sombre': 'sombre', 'nuit': 'sombre', 'espace': 'sombre' };
        let currentTheme = THEMES['defaut'], speechQueue = [], isSpeaking = false, audioCtx = null, currentAudio = null;
        function applyMixedTheme(inputText) { if (!inputText) return; const text = inputText.toLowerCase(); const detectedKeys = new Set(); for (const [key, val] of Object.entries(KEYWORDS)) { if (text.includes(key)) detectedKeys.add(val); } const themes = Array.from(detectedKeys).map(k => THEMES[k]); if (themes.length === 0) return; else if (themes.length === 1) currentTheme = themes[0]; else { const t1 = themes[0]; const t2 = themes[themes.length - 1]; currentTheme = { bg: [t1.bg[0], t2.bg[1], t1.bg[2], t2.bg[3]], star: t1.star, accent: t2.accent, vis: [t1.vis[0], t2.vis[1], t1.vis[2]] }; } const r = document.querySelector(':root'); r.style.setProperty('--bg-1', currentTheme.bg[0]); r.style.setProperty('--bg-2', currentTheme.bg[1]); r.style.setProperty('--bg-3', currentTheme.bg[2]); r.style.setProperty('--bg-4', currentTheme.bg[3]); r.style.setProperty('--accent-color', currentTheme.accent); r.style.setProperty('--vis-1', currentTheme.vis[0]); r.style.setProperty('--vis-2', currentTheme.vis[1]); r.style.setProperty('--vis-3', currentTheme.vis[2]); particles.forEach(p => { if (themes.length > 1) p.color = Math.random() > 0.5 ? themes[0].star : themes[1].star; else p.color = currentTheme.star; }); }

        const canvas = document.getElementById('starfield'); const ctx = canvas.getContext('2d'); let particles = []; let burstParticles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        class Particle { constructor() { this.reset(); } reset() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.size = Math.random() * 2.5 + 0.5; this.speed = Math.random() * 0.02 + 0.01; this.opacity = Math.random() * 0.9; this.color = currentTheme.star; } update() { this.y -= this.speed; this.x += Math.sin(this.y * 0.01) * 0.2; if (this.y < 0) this.reset(); } draw() { ctx.fillStyle = `rgba(${this.color}, ${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } }
        class BurstParticle { constructor(x, y) { this.x = x; this.y = y; const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 15 + 5; this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed; this.life = 1.0; this.decay = Math.random() * 0.015 + 0.005; this.color = Math.random() > 0.5 ? "#fbbf24" : "#ffffff"; this.size = Math.random() * 5 + 2; } update() { this.x += this.vx; this.y += this.vy; this.vy += 0.2; this.vx *= 0.96; this.vy *= 0.96; this.life -= this.decay; } draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1.0; } }
        function initParticles() { particles = []; for (let i = 0; i < 300; i++) particles.push(new Particle()); }
        function triggerBurst() { const centerX = window.innerWidth / 2; const centerY = window.innerHeight / 2; for (let i = 0; i < 300; i++) burstParticles.push(new BurstParticle(centerX, centerY)); }
        function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); for (let i = burstParticles.length - 1; i >= 0; i--) { const p = burstParticles[i]; p.update(); p.draw(); if (p.life <= 0) burstParticles.splice(i, 1); } requestAnimationFrame(animate); }
        window.addEventListener('resize', resize); resize(); initParticles(); animate();

        const vizCanvas = document.getElementById('visualizer-canvas'); const vizCtx = vizCanvas.getContext('2d'); let analyser = null; let dataArray = null; let visualizerAnimationId = null;
        function resizeViz() { if(vizCanvas.parentElement) { vizCanvas.width = vizCanvas.parentElement.offsetWidth; vizCanvas.height = vizCanvas.parentElement.offsetHeight; } }
        window.addEventListener('resize', resizeViz);
        function startVisualizer(audioSource, context) { resizeViz(); if (!analyser) { analyser = context.createAnalyser(); analyser.fftSize = 64; } audioSource.connect(analyser); analyser.connect(context.destination); const bufferLength = analyser.frequencyBinCount; dataArray = new Uint8Array(bufferLength); drawVisualizer(); }
        function drawVisualizer() { visualizerAnimationId = requestAnimationFrame(drawVisualizer); analyser.getByteFrequencyData(dataArray); vizCtx.clearRect(0, 0, vizCanvas.width, vizCanvas.height); const bufferLength = analyser.frequencyBinCount; const gap = 6; const barWidth = (vizCanvas.width / bufferLength) - gap; let barHeight; let x = gap / 2; let gradient = vizCtx.createLinearGradient(0, vizCanvas.height, 0, 0); gradient.addColorStop(0, currentTheme.vis[0]); gradient.addColorStop(0.5, currentTheme.vis[1]); gradient.addColorStop(1, currentTheme.vis[2]); vizCtx.fillStyle = gradient; for (let i = 0; i < bufferLength; i++) { barHeight = (dataArray[i] / 255) * vizCanvas.height; if (barHeight < 5) barHeight = 5; const y = (vizCanvas.height - barHeight) / 2; roundRect(vizCtx, x, y, barWidth, barHeight, 50); x += barWidth + gap; } }
        function roundRect(ctx, x, y, width, height, radius) { if (width < 2 * radius) radius = width / 2; if (height < 2 * radius) radius = height / 2; ctx.beginPath(); ctx.moveTo(x + radius, y); ctx.arcTo(x + width, y, x + width, y + height, radius); ctx.arcTo(x + width, y + height, x, y + height, radius); ctx.arcTo(x, y + height, x, y, radius); ctx.arcTo(x, y, x + width, y, radius); ctx.closePath(); ctx.fill(); }
        function stopVisualizer() { if (visualizerAnimationId) cancelAnimationFrame(visualizerAnimationId); vizCtx.clearRect(0, 0, vizCanvas.width, vizCanvas.height); }

        function playSimpleWoosh() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); const t = audioCtx.currentTime; const bufferSize = audioCtx.sampleRate * 4.0; const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate); const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1; const noise = audioCtx.createBufferSource(); noise.buffer = buffer; const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.Q.value = 1; filter.frequency.setValueAtTime(100, t); filter.frequency.exponentialRampToValueAtTime(3000, t + 1.5); filter.frequency.exponentialRampToValueAtTime(100, t + 4.0); const gain = audioCtx.createGain(); gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.1, t + 1.0); gain.gain.linearRampToValueAtTime(0, t + 4.0); noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination); noise.start(t); noise.stop(t + 4.0); }
        function playSoftPing() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.05); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3); }

        function startListening() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Speech) return; 
            
            if (isSpeaking) {
                stopAudio();
                return;
            }

            const rec = new Speech(); rec.lang = 'fr-FR'; rec.interimResults = false;
            rec.onstart = () => { document.getElementById('btn-mic').classList.add('mic-listening'); document.getElementById('status').innerText = "Je t'√©coute..."; };
            rec.onresult = (e) => { const p = e.results[0][0].transcript; document.getElementById('manualInput').value = p; traiterInput(p); };
            rec.onend = () => document.getElementById('btn-mic').classList.remove('mic-listening');
            rec.onerror = (e) => { document.getElementById('btn-mic').classList.remove('mic-listening'); if (interactionMode === 'NAME_INPUT') document.getElementById('status').innerText = "Comment t'appelles-tu ?"; else if (interactionMode === 'GENDER_INPUT') document.getElementById('status').innerText = "Gar√ßon ou fille ?"; else if (interactionMode === 'COLOR_INPUT') document.getElementById('status').innerText = "Tes couleurs pr√©f√©r√©es ?"; else if (interactionMode === 'DOUDOU_INPUT') document.getElementById('status').innerText = "Ton doudou ?"; else if (interactionMode === 'PET_INPUT') document.getElementById('status').innerText = "Un animal ?"; else if (interactionMode === 'AGE_INPUT') document.getElementById('status').innerText = "Quel √¢ge as-tu ?"; else if (interactionMode === 'STORY_INPUT' || interactionMode === 'QUESTION_INPUT' || interactionMode === 'CHAT_INPUT' || interactionMode === 'MUSIC_INPUT') document.getElementById('status').innerText = "Je n'ai pas entendu..."; };
            try { rec.start(); } catch (e) {}
        }

        function selectMode(mode) {
            currentAppMode = mode;
            if (mode === 'CHAT') {
                chatHistory = []; 
                currentChatActivity = 'TALK'; // Reset au d√©faut
            }
            
            if (mode === 'DRAW') {
                document.getElementById('intro-overlay').classList.add('intro-fade-out');
                setTimeout(() => { document.getElementById('intro-overlay').style.display = 'none'; document.getElementById('slate-layer').style.display = 'block'; initSlate(); }, 800);
            } 
            else if (mode === 'COLORING') {
                document.getElementById('intro-overlay').classList.add('intro-fade-out');
                setTimeout(() => {
                    document.getElementById('intro-overlay').style.display = 'none';
                    document.getElementById('main-interface').classList.add('content-visible');
                    document.getElementById('main-logo-coloring').classList.remove('hidden');
                    document.getElementById('coloring-layer').style.display = 'block'; 
                    document.getElementById('coloring-layer').style.zIndex = "40"; 
                    initColoring(); 
                    lancerColoriageAleatoire();
                }, 800);
            }
            else {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume();
                playSimpleWoosh(); triggerBurst(); document.getElementById('white-flash').classList.add('flash-active');
                setTimeout(() => {
                    document.getElementById('intro-overlay').classList.add('intro-fade-out');
                    document.getElementById('main-interface').classList.add('content-visible');
                    
                    if(mode === 'STORY') {
                        document.getElementById('main-logo-story').classList.remove('hidden');
                        document.body.classList.add('story-mode'); // ACTIVE MODE NUIT
                    }
                    else if(mode === 'QUESTION') document.getElementById('main-logo-question').classList.remove('hidden');
                    else if(mode === 'CHAT') document.getElementById('main-logo-chat').classList.remove('hidden');
                    else if(mode === 'MUSIC') document.getElementById('main-logo-music').classList.remove('hidden');

                    if (userColor) applyMixedTheme(userColor);
                    startInteractionSequence();
                }, 1000);
                setTimeout(() => { document.getElementById('intro-overlay').style.display = 'none'; }, 2000);
            }
        }

        function lancerColoriageAleatoire() {
            const sujets = ["un mignon chaton", "un dinosaure gentil", "une licorne magique", "un robot rigolo", "une belle voiture de course", "un grand ch√¢teau", "un papillon color√©", "un super-h√©ros courageux", "un dragon mignon", "une jolie f√©e"];
            const sujet = sujets[Math.floor(Math.random() * sujets.length)];
            
            interactionMode = 'TELLING'; 
            document.getElementById('status').innerText = "Je pr√©pare ton dessin...";
            document.getElementById('ai-thinking').classList.remove('hidden');
            genererColoriage(sujet);
        }

        function startInteractionSequence() {
            if (!userPrenom || !userGenre || !userAge || !userColor || !userDoudou || !userPet) {
                if (interactionMode === 'INIT') {
                    speechQueue.push("Coucou ! Je suis la petite voix de ta bo√Æte magique. On va cr√©er ton monde merveilleux ensemble, rien que pour toi.");
                    speechQueue.push("Pour commencer, dis-moi : es-tu un gar√ßon ou une fille ?");
                    interactionMode = 'GENDER_INPUT';
                    document.getElementById('status').innerText = "Gar√ßon ou fille ?";
                    parler();
                }
                return;
            }

            if (currentAppMode === 'STORY') {
                interactionMode = 'STORY_INPUT'; document.getElementById('status').innerText = "Quelle histoire veux-tu ?";
                const storyGreetings = [`Coucou ${userPrenom} ! Je suis pr√™te pour une nouvelle aventure. De quoi veux-tu que je parle ?`, `Te revoil√† ${userPrenom} ! Ouvre grand tes oreilles, quelle histoire veux-tu entendre ?`, `Bonjour ${userPrenom}. J'ai plein d'histoires en t√™te aujourd'hui. Dis-moi un mot magique !`, `C'est l'heure de l'histoire ${userPrenom} ! Qu'allons-nous imaginer ensemble ?`, `Salut ${userPrenom} ! Choisis le th√®me de notre aventure !`];
                speechQueue.push(storyGreetings[Math.floor(Math.random() * storyGreetings.length)]);
            } else if (currentAppMode === 'QUESTION') {
                interactionMode = 'QUESTION_INPUT'; document.getElementById('status').innerText = "Pose ta question...";
                const questionGreetings = [`Bonjour ${userPrenom}. Je suis curieuse de t'entendre. Quelle est ta question ?`, `Salut ${userPrenom} ! Le monde est rempli de myst√®res. Qu'est-ce qui t'intrigue ?`, `Coucou ${userPrenom}. Je t'√©coute, pose-moi n'importe quelle question.`, `Je suis pr√™te ${userPrenom}. Qu'est-ce que tu aimerais savoir aujourd'hui ?`];
                speechQueue.push(questionGreetings[Math.floor(Math.random() * questionGreetings.length)]);
            } else if (currentAppMode === 'CHAT') {
                // MODIFICATION : PROPOSITION DE CHOIX
                interactionMode = 'CHAT_CHOICE_INPUT'; 
                document.getElementById('status').innerText = "On fait quoi ?";
                speechQueue.push(`Coucou ${userPrenom} ! Je suis contente de te voir.`);
                speechQueue.push(`On peut juste **discuter**, je peux te raconter des **blagues**, ou on peut jouer aux **devinettes**. Que pr√©f√®res-tu faire ?`);
            } else if (currentAppMode === 'COLORING') {
                interactionMode = 'COLORING_INPUT'; document.getElementById('status').innerText = "Que veux-tu colorier ?";
                speechQueue.push(`C'est l'heure des couleurs ! Dis-moi ${userPrenom}, que veux-tu colorier aujourd'hui ?`);
            } else if (currentAppMode === 'MUSIC') {
                interactionMode = 'MUSIC_INPUT'; document.getElementById('status').innerText = "Que veux-tu √©couter ?";
                speechQueue.push(`Bienvenue dans la bo√Æte √† musique ${userPrenom} ! Dis-moi ce que tu veux : de la guitare, du piano, des chansons de No√´l, ou du rock ?`);
            }
            parler();
        }

        function traiterInput(texte) {
            if (!texte.trim()) return;
            stopAudio(); 
            document.getElementById('manualInput').value = "";
            const lowerText = texte.toLowerCase();

            if (interactionMode === 'GENDER_INPUT') {
                if (lowerText.includes('gar√ßon') || lowerText.includes('homme')) { userGenre = 'gar√ßon'; next(); } else if (lowerText.includes('fille') || lowerText.includes('femme')) { userGenre = 'fille'; next(); } else { speechQueue.push(`Je n'ai pas bien compris. Es-tu un gar√ßon ou une fille ?`); parler(); }
                function next() { localStorage.setItem('BOITE_GENRE', userGenre); interactionMode = 'NAME_INPUT'; document.getElementById('status').innerText = `Comment t'appelles-tu ?`; speechQueue.push(`D'accord. Et comment t'appelles-tu ?`); parler(); }
            } else if (interactionMode === 'NAME_INPUT') {
                userPrenom = texte.replace(/je m'appelle /i, "").replace(/c'est /i, "").trim(); localStorage.setItem('BOITE_PRENOM', userPrenom);
                interactionMode = 'COLOR_INPUT'; document.getElementById('status').innerText = `Tes couleurs pr√©f√©r√©es ?`; speechQueue.push(`Enchant√©e ${userPrenom} ! Quelles sont tes couleurs pr√©f√©r√©es ?`); parler();
            } else if (interactionMode === 'COLOR_INPUT') {
                userColor = texte; localStorage.setItem('BOITE_COLOR', userColor); applyMixedTheme(userColor);
                interactionMode = 'DOUDOU_INPUT'; document.getElementById('status').innerText = `Ton doudou ?`; speechQueue.push(`C'est not√©. Dis-moi, comment s'appelle ton doudou et √† quoi ressemble-t-il ?`); parler();
            } else if (interactionMode === 'DOUDOU_INPUT') {
                userDoudou = texte; localStorage.setItem('BOITE_DOUDOU', userDoudou);
                interactionMode = 'PET_INPUT'; document.getElementById('status').innerText = `Un animal ?`; speechQueue.push(`Oh, il a l'air super ! Et dis-moi, as-tu un animal de compagnie ou un animal pr√©f√©r√© ?`); parler();
            } else if (interactionMode === 'PET_INPUT') {
                userPet = texte; localStorage.setItem('BOITE_ANIMAL', userPet);
                interactionMode = 'AGE_INPUT'; document.getElementById('status').innerText = `Quel √¢ge as-tu ?`; speechQueue.push(`Merci ! Et pour finir, quel √¢ge as-tu ?`); parler();
            } else if (interactionMode === 'AGE_INPUT') {
                userAge = texte.replace(/j'ai /i, "").replace(/ans/i, "").trim(); localStorage.setItem('BOITE_AGE', userAge);
                
                // Conclusion Magique
                speechQueue.push("Merci ! Je m√©lange tes r√©ponses avec un peu de poussi√®re d'√©toiles...");
                speechQueue.push("Et voil√† ! Ta boite magique est pr√™te ! Tu peux maintenant me demander l'histoire que tu veux.");
                
                startInteractionSequence(); 
            } 
            
            else if (interactionMode === 'CHAT_CHOICE_INPUT') {
                // D√âTECTION DU CHOIX DE L'ENFANT
                if (lowerText.includes('blague') || lowerText.includes('rigoler')) {
                    currentChatActivity = 'JOKE';
                    speechQueue.push("Super ! J'adore les blagues. √âcoute bien celle-ci...");
                    interactionMode = 'TELLING'; 
                    appelIA("Raconte-moi une blague", 'CHAT');
                } else if (lowerText.includes('devinette') || lowerText.includes('jouer') || lowerText.includes('jeu')) {
                    currentChatActivity = 'RIDDLE';
                    speechQueue.push("G√©nial, on va jouer ! Je vais te poser une devinette.");
                    interactionMode = 'TELLING'; 
                    appelIA("Pose-moi une devinette", 'CHAT');
                } else {
                    currentChatActivity = 'TALK'; // Par d√©faut : discussion
                    interactionMode = 'TELLING';
                    appelIA(texte, 'CHAT');
                }
            }

            else if (interactionMode === 'STORY_INPUT') { interactionMode = 'TELLING'; appelIA(texte, 'STORY'); } 
            else if (interactionMode === 'QUESTION_INPUT') { interactionMode = 'TELLING'; appelIA(texte, 'QUESTION'); }
            else if (interactionMode === 'CHAT_INPUT') { interactionMode = 'TELLING'; appelIA(texte, 'CHAT'); }
            else if (interactionMode === 'MUSIC_INPUT') { interactionMode = 'TELLING'; appelIA(texte, 'MUSIC'); }
            else if (interactionMode === 'COLORING_INPUT') { 
                interactionMode = 'TELLING';
                document.getElementById('status').innerText = "Je dessine...";
                document.getElementById('ai-thinking').classList.remove('hidden');
                genererColoriage(texte);
            }
        }

        function playSpotify(key) {
            const playlistId = SPOTIFY_DB[key] || SPOTIFY_DB['POP'];
            const container = document.getElementById('spotify-container');
            const iframe = document.getElementById('spotify-frame');
            
            // Masquer le visualiseur audio car Spotify prend la place
            document.getElementById('story-card').classList.add('hidden');
            
            // Format URL Spotify standard et fiable
            iframe.src = `https://open.spotify.com/embed/playlist/${playlistId}?utm_source=generator&theme=0`;
            container.classList.add('active');
            
            speechQueue.push("C'est parti ! Musique maestro !");
            parler();
        }

        function stopAudio() {
            isWaitingForResponse = false; 
            
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            stopVisualizer(); speechQueue = []; isSpeaking = false;
            document.getElementById('main-header').classList.remove('cinema-mode');
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('ai-thinking').classList.add('hidden');
            
            if (['NAME_INPUT', 'GENDER_INPUT', 'COLOR_INPUT', 'DOUDOU_INPUT', 'PET_INPUT', 'AGE_INPUT'].includes(interactionMode)) {} 
            else if (currentAppMode === 'STORY') { interactionMode = 'STORY_INPUT'; document.getElementById('status').innerText = "Une autre histoire ?"; } 
            else if (currentAppMode === 'QUESTION') { interactionMode = 'QUESTION_INPUT'; document.getElementById('status').innerText = "Une autre question ?"; }
            else if (currentAppMode === 'CHAT') { 
                // Retour au mode actif apr√®s une interaction
                if (interactionMode === 'CHAT_CHOICE_INPUT') {
                     // On reste en attente du choix
                     document.getElementById('status').innerText = "Blague, Devinette ou Papote ?";
                } else {
                    interactionMode = 'CHAT_INPUT';
                    document.getElementById('status').innerText = "√Ä toi..."; 
                }
            }
            else if (currentAppMode === 'COLORING') { interactionMode = 'COLORING_INPUT'; document.getElementById('status').innerText = "Autre chose ?"; }
            else if (currentAppMode === 'MUSIC') { interactionMode = 'MUSIC_INPUT'; document.getElementById('status').innerText = "Une autre chanson ?"; }

            toggleStopButton(false); document.getElementById('story-card').classList.add('hidden'); 
        }

        function toggleStopButton(active) {
            const container = document.getElementById('stop-container');
            if (active) { container.classList.remove('opacity-20', 'pointer-events-none'); container.classList.add('opacity-100'); } else { container.classList.add('opacity-20', 'pointer-events-none'); container.classList.remove('opacity-100'); }
        }

        async function appelIA(sujet, mode) {
            stopAudio();
            interactionMode = 'TELLING'; 
            isWaitingForResponse = true; 
            
            const btnMic = document.getElementById('btn-mic');
            const statusLabel = document.getElementById('status');
            const waves = document.getElementById('ai-thinking');
            
            // --- MODIFICATION ICI : PHRASE D'ATTENTE SEULEMENT POUR HISTOIRE ---
            if (mode === 'STORY') {
                const randomPhrase = MAGIC_PHRASES[Math.floor(Math.random() * MAGIC_PHRASES.length)];
                document.getElementById('status').innerText = randomPhrase;
                speechQueue.push(randomPhrase); 
                parler();
            } else {
                // Pour Question et Chat, pas de phrase orale d'attente
                document.getElementById('status').innerText = "Je r√©fl√©chis...";
                // On n'appelle pas parler(), l'animation des vagues se lance ci-dessous
            }
            // --------------------------------------------------------------------
            
            playSoftPing(); btnMic.classList.add('understood-flash'); 
            statusLabel.classList.add('hidden'); 
            waves.classList.remove('hidden');
            
            setTimeout(() => { btnMic.classList.remove('understood-flash'); toggleStopButton(true); }, 800);
            
            // Construction du prompt
            let promptIA = "";
            let contextChild = ""; 
            if (userPrenom) contextChild += `L'enfant s'appelle ${userPrenom} (${userGenre}, ${userAge} ans). `; 
            if (userDoudou) contextChild += `Son doudou est ${userDoudou}. `;
            if (userPet) contextChild += `Il aime les animaux, surtout : ${userPet}. `;

            if (mode === 'STORY') {
                promptIA = `Tu es une conteuse. ${contextChild} Raconte une aventure sur : "${sujet}". R√àGLES : Pas de violence, ton doux, fin heureuse. Tu peux faire un clin d'≈ìil √† son doudou ou √† son animal pr√©f√©r√© si √ßa s'y pr√™te. IMPORTANT : Ne jamais utiliser d'interjections comme 'Ohlala', 'Hmm', 'H√© bien', 'Oh'. Commence directement l'histoire.`;
            } else if (mode === 'QUESTION') {
                promptIA = `Encyclop√©die bienveillante. ${contextChild} L'enfant demande : "${sujet}". R√©ponds simplement (3-4 phrases).`;
            } else if (mode === 'CHAT') {
                chatHistory.push({ role: "user", content: sujet });
                const recentHistory = chatHistory.slice(-6).map(msg => `${msg.role === 'user' ? 'Enfant' : 'Toi (IA)'}: ${msg.content}`).join('\n');
                
                let instructionSpecifique = "";
                if (currentChatActivity === 'JOKE') {
                    instructionSpecifique = "Ton but est de faire rire l'enfant. Raconte une blague courte et adapt√©e √† son √¢ge. Si l'enfant a d√©j√† ri, propose-en une autre.";
                } else if (currentChatActivity === 'RIDDLE') {
                    instructionSpecifique = "Tu es un ma√Ætre des √©nigmes gentil. Pose une devinette simple adapt√©e √† son √¢ge. Si l'enfant r√©pond, dis-lui si c'est bon ou donne un indice. Ne donne pas la r√©ponse tout de suite.";
                } else {
                    instructionSpecifique = "Tu es une amie magique bienveillante. Discute simplement avec lui, pose des questions sur sa journ√©e ou ses go√ªts.";
                }

                promptIA = `Tu parles avec ${userPrenom}, ${userAge} ans. ${instructionSpecifique} Historique : ${recentHistory} R√©ponds √† l'enfant :`;
            
            } else if (mode === 'MUSIC') {
                const availableKeys = Object.keys(SPOTIFY_DB).join(', ');
                promptIA = `Tu es un DJ. L'enfant demande : "${sujet}". Cl√©s dispos : ${availableKeys}. R√©ponds UNIQUEMENT par le mot cl√© (ex: ROCK). Si inconnu, r√©pond POP.`;
            }

            try {
                console.log("Envoi demande IA...");
                
                const response = await fetch('/api/gemini', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ prompt: promptIA }) 
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    const errMessage = errData.error || "Erreur serveur " + response.status;
                    throw new Error(errMessage);
                }

                const data = await response.json();
                
                if (!data.text) {
                    throw new Error("R√©ponse IA vide (data.text missing)");
                }

                isWaitingForResponse = false;

                waves.classList.add('hidden'); statusLabel.classList.remove('hidden'); 
                
                if (mode === 'MUSIC') {
                    const cleanKey = data.text.trim().toUpperCase().replace(/[^A-Z_]/g, '');
                    playSpotify(cleanKey);
                    interactionMode = 'MUSIC_INPUT';
                } else {
                    if (mode === 'STORY') {
                        statusLabel.innerText = STORY_START_PHRASES[Math.floor(Math.random() * STORY_START_PHRASES.length)];
                    } else {
                        statusLabel.innerText = "Je te r√©ponds...";
                    }
                    
                    const parts = data.text.split(/([.!?;:]|\n)/);
                    let foundText = false;
                    for (let i = 0; i < parts.length - 1; i += 2) { 
                        const p = (parts[i] + (parts[i+1] || "")).trim(); 
                        if (p.length > 2) { 
                            speechQueue.push(p); 
                            if(!isSpeaking) parler(); 
                            foundText = true;
                        } 
                    }
                    if (!foundText && data.text.trim().length > 0) {
                        speechQueue.push(data.text.trim());
                        if(!isSpeaking) parler();
                    }

                    if (mode === 'CHAT') chatHistory.push({ role: "model", content: data.text });
                    
                    if (mode === 'CHAT') interactionMode = 'CHAT_INPUT';
                    else if (mode === 'STORY') interactionMode = 'STORY_INPUT';
                    else if (mode === 'QUESTION') interactionMode = 'QUESTION_INPUT';
                }

            } catch (e) { 
                console.error("ERREUR APP:", e);
                isWaitingForResponse = false; 
                waves.classList.add('hidden'); 
                statusLabel.classList.remove('hidden'); 
                statusLabel.innerText = "Oups !"; 
                alert("Erreur technique : " + e.message);
            }
        }

        async function textToSpeechAzure(text) {
            try {
                const response = await fetch('/api/azure', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ text: text }) 
                });
                if (!response.ok) throw new Error("Erreur Azure"); 
                return await response.blob();
            } catch (e) { return null; }
        }

        async function parler() {
            if (isSpeaking || speechQueue.length === 0) return;
            isSpeaking = true; toggleStopButton(true); document.getElementById('main-header').classList.add('cinema-mode'); 
            
            // Note: Le mode sommeil est activ√© dans selectMode() pour les histoires et reste actif.

            const spotifyActive = document.getElementById('spotify-container').classList.contains('active');
            if(!spotifyActive) {
                document.getElementById('story-card').classList.remove('hidden'); 
                resizeViz();
            }

            let txt = speechQueue.shift().replace(/[#*`_]/g, '');
            
            const audioBlob = await textToSpeechAzure(txt);
            if (audioBlob) {
                const audioUrl = URL.createObjectURL(audioBlob); currentAudio = new Audio(audioUrl); 
                if(!spotifyActive) {
                    const source = audioCtx.createMediaElementSource(currentAudio); startVisualizer(source, audioCtx);
                }
                currentAudio.onended = () => {
                    isSpeaking = false;
                    if (speechQueue.length === 0) { 
                        if (isWaitingForResponse) return; 

                        stopAudio();
                        // AJOUT DE 'CHAT_CHOICE_INPUT' DANS LA LISTE DE RELANCE
                        if (['NAME_INPUT', 'GENDER_INPUT', 'COLOR_INPUT', 'AGE_INPUT', 'STORY_INPUT', 'QUESTION_INPUT', 'CHAT_INPUT', 'CHAT_CHOICE_INPUT', 'COLORING_INPUT', 'MUSIC_INPUT', 'DOUDOU_INPUT', 'PET_INPUT'].includes(interactionMode)) {
                            setTimeout(() => { startListening(); }, 500);
                        }
                    } else parler(); 
                };
                currentAudio.play();
            } else {
                // FALLBACK NAVIGATEUR
                const utterance = new SpeechSynthesisUtterance(txt);
                utterance.lang = 'fr-FR';
                utterance.rate = 0.9;
                utterance.onend = () => {
                    isSpeaking = false;
                    if (speechQueue.length === 0) {
                        if (isWaitingForResponse) return; 
                        stopAudio();
                        if (['NAME_INPUT', 'GENDER_INPUT', 'COLOR_INPUT', 'AGE_INPUT', 'STORY_INPUT', 'QUESTION_INPUT', 'CHAT_INPUT', 'CHAT_CHOICE_INPUT', 'COLORING_INPUT', 'MUSIC_INPUT', 'DOUDOU_INPUT', 'PET_INPUT'].includes(interactionMode)) {
                            setTimeout(() => { startListening(); }, 500);
                        }
                    } else parler();
                };
                window.speechSynthesis.speak(utterance);
            }
        }

        function oublierTout() { localStorage.removeItem('BOITE_PRENOM'); localStorage.removeItem('BOITE_AGE'); localStorage.removeItem('BOITE_GENRE'); localStorage.removeItem('BOITE_COLOR'); localStorage.removeItem('BOITE_DOUDOU'); localStorage.removeItem('BOITE_ANIMAL'); location.reload(); }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btn-mic').onclick = () => { startListening(); };
            document.getElementById('btn-stop').onclick = stopAudio;
        });
    </script>
</body>
</html>