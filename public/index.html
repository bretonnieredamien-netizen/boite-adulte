<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEURO - Assistant TDAH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- DESIGN NEURO-INCLUSIF --- */
        :root { --bg-main: #121212; --bg-card: #1E1E1E; --accent: #BB86FC; --accent-soft: rgba(187, 134, 252, 0.2); --text-main: #E0E0E0; --success: #03DAC6; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-main); height: 100vh; overflow: hidden; margin: 0; touch-action: none; display: flex; flex-direction: column; justify-content: space-between; }
        .mic-wrapper { position: relative; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; margin: 0 auto; }
        .mic-btn { width: 80px; height: 80px; border-radius: 50%; background: var(--bg-card); border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: all 0.3s; cursor: pointer; z-index: 10; }
        .mic-btn svg { width: 32px; height: 32px; fill: var(--text-main); transition: fill 0.3s; }
        .mic-btn.active { background: var(--accent); transform: scale(1.1); box-shadow: 0 0 30px var(--accent); }
        .mic-btn.active svg { fill: #121212; }
        .breath-circle { position: absolute; border-radius: 50%; border: 1px solid var(--accent); opacity: 0; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .listening .breath-circle { animation: breathe 3s infinite; }
        .listening .breath-circle:nth-child(1) { width: 100px; height: 100px; animation-delay: 0s; }
        .listening .breath-circle:nth-child(2) { width: 120px; height: 120px; animation-delay: 0.5s; }
        .listening .breath-circle:nth-child(3) { width: 140px; height: 140px; animation-delay: 1s; }
        @keyframes breathe { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; } 100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; } }
        .mode-selector { display: flex; gap: 10px; overflow-x: auto; padding: 20px; padding-bottom: 40px; scrollbar-width: none; justify-content: center; }
        .mode-card { background: var(--bg-card); padding: 15px 20px; border-radius: 16px; min-width: 90px; text-align: center; border: 1px solid transparent; transition: all 0.3s; opacity: 0.5; cursor: pointer; }
        .mode-card.active { opacity: 1; border-color: var(--accent); background: var(--accent-soft); transform: translateY(-5px); }
        .mode-icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .mode-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .feedback-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .main-instruction { font-size: 18px; font-weight: 300; line-height: 1.6; max-width: 320px; transition: opacity 0.3s; }
        .status-pill { background: #2C2C2C; padding: 6px 16px; border-radius: 20px; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: #888; margin-bottom: 24px; transition: all 0.3s; }
        .action-log { font-size: 10px; color: var(--success); margin-top: 10px; opacity: 0; transition: opacity 0.5s; }
    </style>
</head>
<body>

    <div class="pt-10 text-center">
        <h1 class="text-2xl font-bold tracking-widest text-white">NEURO</h1>
        <p class="text-[10px] text-gray-500 uppercase tracking-[0.3em] mt-1">Brain OS v2.0</p>
    </div>

    <div class="feedback-area">
        <div id="status-display" class="status-pill">En attente</div>
        <p id="ai-response" class="main-instruction">
            Je suis prÃªt.<br>Choisis un mode.
        </p>
        <div id="action-feedback" class="action-log">Action envoyÃ©e ! âœ…</div>
    </div>

    <div class="mic-wrapper" id="mic-wrapper">
        <div class="breath-circle"></div>
        <div class="breath-circle"></div>
        <div class="breath-circle"></div>
        <div id="btn-mic" class="mic-btn">
            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        </div>
    </div>

    <div class="mode-selector">
        <div class="mode-card active" onclick="setMode('DUMP', this)">
            <span class="mode-icon">ðŸ§ </span>
            <span class="mode-label">Vider</span>
        </div>
        <div class="mode-card" onclick="setMode('FOCUS', this)">
            <span class="mode-icon">âš¡</span>
            <span class="mode-label">Focus</span>
        </div>
        <div class="mode-card" onclick="setMode('ROUTINE', this)">
            <span class="mode-icon">ðŸ”„</span>
            <span class="mode-label">Routine</span>
        </div>
    </div>

    <script>
        // =========================================================================
        // ðŸ‘‡ ZONE DE CONFIGURATION (REMPLISSEZ LES 3 LIGNES) ðŸ‘‡
        // =========================================================================
        
        // 1. TON LIEN VERCEL (OBLIGATOIRE)
        const API_BASE_URL = "https://boite-adulte.vercel.app/"; 

        // 2. LE WEBHOOK POUR L'AGENDA (Celui que tu as dÃ©jÃ )
        const URL_CALENDRIER = "https://hook.eu1.make.com/l3agyq8s6bh1qp5vw4pruulekij94fai";

        // 3. LE NOUVEAU WEBHOOK POUR LES TÃ‚CHES (Le nouveau)
        const URL_TACHES = "https://hook.eu1.make.com/l3agyq8s6bh1qp5vw4pruulekij94fai";

        // =========================================================================

        let currentMode = 'DUMP';
        let isProcessing = false;

        const PROMPTS = {
            'DUMP': `Tu es un assistant exÃ©cutif.
            RÃ©ponds UNIQUEMENT avec ce format JSON strict (sans markdown) :
            {
                "text": "Ta phrase de confirmation.",
                "actions": [
                    { "type": "CALENDAR", "detail": "Rdv dentiste..." },
                    { "type": "TODO", "detail": "Acheter pain..." }
                ]
            }
            REGLE : Si date/heure prÃ©cise -> CALENDAR. Sinon -> TODO.`,
            
            'FOCUS': `Coach anti-procrastination. JSON Strict: { "text": "...", "actions": [] }`,
            'ROUTINE': `Guide routine. JSON Strict: { "text": "...", "actions": [] }`
        };

        function setMode(mode, btn) {
            currentMode = mode;
            document.querySelectorAll('.mode-card').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('ai-response').innerText = "PrÃªt.";
        }

        const btnMic = document.getElementById('btn-mic');
        const micWrapper = document.getElementById('mic-wrapper');
        const statusDisplay = document.getElementById('status-display');

        btnMic.addEventListener('click', () => { if (!isProcessing) startListening(); });

        function startListening() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Speech) { alert("Micro HS"); return; }
            const rec = new Speech();
            rec.lang = 'fr-FR';
            rec.interimResults = false;
            rec.onstart = () => { micWrapper.classList.add('listening'); btnMic.classList.add('active'); statusDisplay.innerText = "J'Ã©coute..."; };
            rec.onend = () => { micWrapper.classList.remove('listening'); btnMic.classList.remove('active'); };
            rec.onresult = (ev) => { processWithAI(ev.results[0][0].transcript); };
            rec.start();
        }

        // --- C'EST ICI QUE SE FAIT LE TRI DES ROUTES ---
        async function sendToAutomation(actions) {
            if (!actions || actions.length === 0) return;
            const feedback = document.getElementById('action-feedback');
            
            for (let action of actions) {
                let targetUrl = "";
                let typeNom = "";

                // LE TRI AUTOMATIQUE
                if (action.type === 'CALENDAR') {
                    targetUrl = URL_CALENDRIER;
                    typeNom = "Agenda";
                } else {
                    targetUrl = URL_TACHES; // Tout le reste va ici (Pain, Piles, etc.)
                    typeNom = "TÃ¢ches";
                }

                console.log(`Envoi de "${action.detail}" vers ${typeNom}`);
                feedback.innerHTML = `Envoi vers ${typeNom}...`;
                feedback.style.opacity = 1;

                try {
                    if(targetUrl.includes("METTRE_LE_LIEN")) {
                        console.error("Lien Make manquant !");
                        continue;
                    }
                    
                    await fetch(targetUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ detail: action.detail, type: action.type })
                    });
                } catch (e) { console.error(e); }
            }
            
            feedback.innerHTML = `EnvoyÃ© ! âœ…`;
            setTimeout(() => feedback.style.opacity = 0, 4000);
        }

        async function processWithAI(userInput) {
            isProcessing = true;
            statusDisplay.innerText = "Analyse...";

            const fullPrompt = `${PROMPTS[currentMode]}\n\nUTILISATEUR : "${userInput}"`;

            try {
                if(API_BASE_URL.includes("METTRE_TON_LIEN")) { alert("Erreur: Lien Vercel manquant ligne 170"); isProcessing = false; return; }

                // 1. GEMINI
                const rep1 = await fetch(`${API_BASE_URL}/api/gemini`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ prompt: fullPrompt })
                });
                const data1 = await rep1.json();
                
                let cleanJson = data1.text.replace(/```json/g, '').replace(/```/g, '').trim();
                let parsedData;
                try { parsedData = JSON.parse(cleanJson); } catch (e) { parsedData = { text: data1.text, actions: [] }; }

                document.getElementById('ai-response').innerText = parsedData.text;
                
                // 2. ENVOI AUX WEBHOOKS
                await sendToAutomation(parsedData.actions);

                // 3. AUDIO
                statusDisplay.innerText = "SynthÃ¨se...";
                const rep2 = await fetch(`${API_BASE_URL}/api/azure`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: parsedData.text })
                });

                if (rep2.ok) {
                    const blob = await rep2.blob();
                    const audio = new Audio(URL.createObjectURL(blob));
                    statusDisplay.innerText = "Lecture...";
                    audio.play();
                    audio.onended = () => { isProcessing = false; statusDisplay.innerText = "En attente"; };
                } else {
                    const utt = new SpeechSynthesisUtterance(parsedData.text);
                    utt.lang = 'fr-FR'; window.speechSynthesis.speak(utt);
                    isProcessing = false; statusDisplay.innerText = "En attente";
                }

            } catch (e) { console.error(e); statusDisplay.innerText = "Erreur"; isProcessing = false; }
        }
    </script>
</body>
</html>