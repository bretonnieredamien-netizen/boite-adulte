<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEURO - Assistant TDAH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- DESIGN NEURO-INCLUSIF (Apaisant, Sombre, Contraste doux) --- */
        :root { 
            --bg-main: #121212; 
            --bg-card: #1E1E1E; 
            --accent: #BB86FC; /* Violet apaisant */
            --accent-soft: rgba(187, 134, 252, 0.2);
            --text-main: #E0E0E0;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main);
            color: var(--text-main);
            height: 100vh; overflow: hidden; margin: 0; touch-action: none;
            display: flex; flex-col;
        }

        /* BOUTON MICRO RESPIRANT */
        .mic-wrapper {
            position: relative;
            width: 100px; height: 100px;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto;
        }
        
        .mic-btn {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--accent);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer; z-index: 10;
        }
        
        .mic-btn svg { width: 32px; height: 32px; fill: var(--text-main); transition: fill 0.3s; }
        .mic-btn.active { background: var(--accent); transform: scale(1.1); box-shadow: 0 0 30px var(--accent); }
        .mic-btn.active svg { fill: #121212; }

        /* CIRCLES ANIMATION (BREATHING) */
        .breath-circle {
            position: absolute; border-radius: 50%;
            border: 1px solid var(--accent); opacity: 0;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .listening .breath-circle { animation: breathe 3s infinite; }
        .listening .breath-circle:nth-child(1) { width: 100px; height: 100px; animation-delay: 0s; }
        .listening .breath-circle:nth-child(2) { width: 120px; height: 120px; animation-delay: 0.5s; }
        .listening .breath-circle:nth-child(3) { width: 140px; height: 140px; animation-delay: 1s; }

        @keyframes breathe {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
            100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
        }

        /* MODES CARDS */
        .mode-selector {
            display: flex; gap: 10px; overflow-x: auto; padding: 20px;
            scrollbar-width: none; justify-content: center;
        }
        .mode-card {
            background: var(--bg-card);
            padding: 15px 20px;
            border-radius: 20px;
            min-width: 100px;
            text-align: center;
            border: 1px solid transparent;
            transition: all 0.3s;
            opacity: 0.5;
            cursor: pointer;
        }
        .mode-card.active {
            opacity: 1;
            border-color: var(--accent);
            background: var(--accent-soft);
            transform: translateY(-5px);
        }
        .mode-icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .mode-label { font-size: 12px; font-weight: 700; uppercase; letter-spacing: 1px; }

        /* TEXTE FEEDBACK */
        .feedback-area {
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center; padding: 20px;
        }
        .main-instruction { font-size: 18px; font-weight: 300; line-height: 1.6; max-width: 300px; }
        .status-pill { 
            background: #2C2C2C; padding: 5px 15px; border-radius: 20px; 
            font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: #888; margin-bottom: 20px; 
        }

    </style>
</head>
<body class="flex flex-col justify-between">

    <div class="pt-8 text-center">
        <h1 class="text-2xl font-bold tracking-widest text-white">NEURO</h1>
        <p class="text-[10px] text-gray-500 uppercase tracking-[0.3em] mt-1">External Brain System</p>
    </div>

    <div class="feedback-area">
        <div id="status-display" class="status-pill">En attente</div>
        <p id="ai-response" class="main-instruction">
            Je suis ton second cerveau.<br>
            Choisis un mode et appuie sur le bouton.
        </p>
    </div>

    <div class="mic-wrapper" id="mic-wrapper">
        <div class="breath-circle"></div>
        <div class="breath-circle"></div>
        <div class="breath-circle"></div>
        <div id="btn-mic" class="mic-btn">
            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        </div>
    </div>

    <div class="mode-selector pb-10">
        <div class="mode-card active" onclick="setMode('DUMP', this)">
            <span class="mode-icon">ðŸ§ </span>
            <span class="mode-label">Vider</span>
        </div>
        <div class="mode-card" onclick="setMode('FOCUS', this)">
            <span class="mode-icon">âš¡</span>
            <span class="mode-label">Focus</span>
        </div>
        <div class="mode-card" onclick="setMode('ROUTINE', this)">
            <span class="mode-icon">ðŸ”„</span>
            <span class="mode-label">Routine</span>
        </div>
    </div>

    <script>
        // ==========================================
        // URL VERCEL
        // ==========================================
        const API_BASE_URL = "https://boite-adulte.vercel.app/";
        // ==========================================

        let currentMode = 'DUMP';
        let isProcessing = false;
        let isSpeaking = false;

        // Prompts spÃ©cialisÃ©s TDAH / Charge Mentale
        const PROMPTS = {
            'DUMP': `Tu es un assistant personnel pour quelqu'un qui a un TDAH. 
            L'utilisateur va te donner plein d'infos en vrac. Ta mission :
            1. Ã‰couter et ne pas juger.
            2. Trier mentalement les infos (Agenda, To-Do, Notes).
            3. RÃ©pondre UNIQUEMENT en confirmant que c'est triÃ©, sur un ton calme et rassurant.
            Exemple : "C'est notÃ©. J'ai mis le dentiste dans l'agenda et le lait sur la liste de courses. Autre chose ?"`,

            'FOCUS': `Tu es un coach spÃ©cialisÃ© en fonctions exÃ©cutives.
            L'utilisateur est paralysÃ© devant une tÃ¢che.
            1. Demande quelle est la tÃ¢che.
            2. DÃ©coupe-la en la toute premiÃ¨re Ã©tape RIDICULEMENT petite et facile (la "micro-Ã©tape").
            3. Sois encourageant. Ne donne PAS toute la liste, juste la premiÃ¨re Ã©tape.
            Exemple : "Ok, on respire. Pour ranger le garage, Ã©tape 1 : Va juste chercher un sac poubelle. C'est tout. Dis-moi quand c'est fait."`,

            'ROUTINE': `Tu es un pilote de routine bienveillant.
            L'utilisateur a du mal Ã  gÃ©rer son temps le matin ou le soir.
            Guide-le pas Ã  pas. Sois dynamique mais pas stressant.
            Donne une consigne simple et un dÃ©lai court.
            Exemple : "Allez champion. On attaque. 2 minutes pour brosser les dents. Go !"`,
        };

        function setMode(mode, btn) {
            currentMode = mode;
            document.querySelectorAll('.mode-card').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            
            const texts = {
                'DUMP': "Vide ton sac. Dis-moi tout ce qui traÃ®ne dans ta tÃªte.",
                'FOCUS': "Quelle tÃ¢che te fait peur ou te bloque ?",
                'ROUTINE': "On lance la routine du Matin ou du Soir ?"
            };
            document.getElementById('ai-response').innerText = texts[mode];
            window.speechSynthesis.cancel();
        }

        const btnMic = document.getElementById('btn-mic');
        const micWrapper = document.getElementById('mic-wrapper');
        const statusDisplay = document.getElementById('status-display');

        btnMic.addEventListener('click', () => {
            if (isProcessing) return;
            startListening();
        });

        function startListening() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Speech) { alert("Pas de micro dÃ©tectÃ©"); return; }

            const rec = new Speech();
            rec.lang = 'fr-FR';
            rec.interimResults = false;

            rec.onstart = () => {
                micWrapper.classList.add('listening');
                btnMic.classList.add('active');
                statusDisplay.innerText = "J'Ã©coute...";
                statusDisplay.style.color = "#BB86FC";
            };

            rec.onend = () => {
                micWrapper.classList.remove('listening');
                btnMic.classList.remove('active');
            };

            rec.onresult = (event) => {
                const text = event.results[0][0].transcript;
                processWithAI(text);
            };

            rec.start();
        }

        async function processWithAI(userInput) {
            isProcessing = true;
            statusDisplay.innerText = "RÃ©flexion...";
            document.getElementById('ai-response').innerText = "...";

            // Construction du Prompt
            const sysPrompt = PROMPTS[currentMode];
            const fullPrompt = `${sysPrompt}\n\nUTILISATEUR : "${userInput}"`;

            try {
                // 1. GEMINI
                const rep1 = await fetch(`${API_BASE_URL}/api/gemini`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ prompt: fullPrompt })
                });
                const data1 = await rep1.json();
                const aiText = data1.text;
                
                document.getElementById('ai-response').innerText = aiText;

                // 2. AZURE TTS
                statusDisplay.innerText = "SynthÃ¨se...";
                const rep2 = await fetch(`${API_BASE_URL}/api/azure`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: aiText })
                });

                if (rep2.ok) {
                    const blob = await rep2.blob();
                    const url = URL.createObjectURL(blob);
                    const audio = new Audio(url);
                    statusDisplay.innerText = "Lecture...";
                    audio.play();
                    audio.onended = () => { 
                        isProcessing = false; 
                        statusDisplay.innerText = "En attente";
                        statusDisplay.style.color = "#888";
                    };
                } else {
                    // Fallback
                    const utt = new SpeechSynthesisUtterance(aiText);
                    utt.lang = 'fr-FR';
                    window.speechSynthesis.speak(utt);
                    isProcessing = false;
                }

            } catch (e) {
                console.error(e);
                statusDisplay.innerText = "Erreur rÃ©seau";
                isProcessing = false;
            }
        }
    </script>
</body>
</html>