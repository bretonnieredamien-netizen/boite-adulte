<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEURO - Assistant TDAH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- DESIGN NEURO V39 (FINAL LAYOUT) --- */
        :root { 
            --bg-main: #121212; --bg-card: #1E1E1E; 
            --accent: #2979FF; --text-main: #E0E0E0;
            --success: #00E676; --warning: #FFAB00; --danger: #FF1744;
            --reminder: #D500F9; --capacity: #00E5FF; --date-badge: #FF4081;
        }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-main); height: 100vh; overflow: hidden; margin: 0; touch-action: none; display: flex; flex-direction: column; }

        /* --- HEADER (Logo Gauche / Boutons Droite) --- */
        .header { padding: 15px 15px 5px 45px; /* Marge gauche pour sidebar */ background: #121212; z-index: 10; border-bottom: 1px solid #333; position: relative; }
        .header-content { display: flex; align-items: center; justify-content: space-between; height: 50px; }
        
        /* LOGO */
        .app-logo-container { display: flex; align-items: center; }
        .app-logo-svg { width: 70px; height: auto; filter: drop-shadow(0 0 8px rgba(41, 121, 255, 0.4)); }
        .brain-pulse { animation: brainPulse 3s infinite ease-in-out; transform-origin: center; }
        @keyframes brainPulse { 0%, 100% { opacity: 0.8; stroke-width: 2px; } 50% { opacity: 1; stroke-width: 3px; filter: drop-shadow(0 0 5px var(--accent)); } }

        /* GROUPE BOUTONS DROITE */
        .header-actions { display: flex; gap: 8px; align-items: center; }
        .header-btn { background: #222; border: 1px solid #444; color: #888; font-size: 10px; font-weight: bold; padding: 6px 10px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap; }
        
        .btn-zen.active { border-color: var(--success); color: var(--success); background: rgba(0, 230, 118, 0.1); }
        .btn-boost.active { border-color: var(--danger); color: var(--danger); background: rgba(255, 23, 68, 0.1); }
        
        .btn-audio.active { border-color: var(--accent); color: var(--accent); background: rgba(41, 121, 255, 0.1); box-shadow: 0 0 10px rgba(41, 121, 255, 0.2); }
        .sound-wave { display: inline-block; height: 8px; width: 2px; background: currentColor; animation: sound 0.5s infinite; margin-left:2px; }
        @keyframes sound { 0%, 100% { height: 3px; } 50% { height: 8px; } }

        .btn-brief { background: rgba(255, 171, 0, 0.1); border: 1px solid var(--warning); color: var(--warning); }

        /* MONITOR CHARGE MENTALE */
        .monitor-wrapper { width: 100%; margin-top: 10px; height: 4px; border-radius: 2px; background: #222; overflow: hidden; }
        .load-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00E676 0%, #FFAB00 60%, #FF1744 100%); transition: width 0.6s ease-out; }

        /* SIDEBAR GAUCHE (CAPACIT√â) */
        .capacity-sidebar { position: fixed; left: 0; top: 0; bottom: 100px; width: 10px; background: #0f0f0f; border-right: 1px solid #222; display: flex; flex-direction: column; justify-content: flex-end; z-index: 40; }
        .capacity-track { width: 100%; height: 100%; background: #0f0f0f; position: relative; overflow: hidden; }
        .capacity-fill { width: 100%; height: 0%; background: var(--capacity); position: absolute; bottom: 0; left: 0; transition: height 0.6s; opacity: 0.8; }

        /* CONTENT */
        .content-area { flex: 1; overflow-y: auto; position: relative; scrollbar-width: none; padding-left: 10px; padding-top: 10px; }
        .view-section { display: none; height: 100%; flex-direction: column; width: 100%; }
        .view-section.active { display: flex; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 1. TASK LIST */
        .task-container { padding: 10px 10px 100px 10px; display: flex; flex-direction: column; gap: 10px; }
        .task-item { background: var(--bg-card); padding: 12px 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; border-left: 3px solid var(--accent); transition: all 0.2s; }
        .task-item:active { transform: scale(0.98); background: #252525; }
        
        .task-item.priority-high { border-left-color: var(--danger); background: linear-gradient(90deg, rgba(255, 23, 68, 0.1), var(--bg-card)); }
        .task-item.calendar { border-left-color: #FF4081; background: #1F1518; }
        .task-item.reminder { border-left-color: var(--reminder); background: linear-gradient(90deg, rgba(213, 0, 249, 0.1), var(--bg-card)); }
        
        .task-text { font-size: 14px; font-weight: 500; outline: none; flex: 1; color: white; }
        .task-sub { font-size: 9px; opacity: 0.7; text-transform: uppercase; margin-top: 4px; display: flex; gap: 6px; align-items: center; }
        
        .time-badge, .date-badge { background: #333; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 9px; display: flex; align-items: center; gap: 3px; border: 1px solid rgba(255,255,255,0.1); }
        .time-badge { color: var(--capacity); border-color: rgba(0, 229, 255, 0.3); }
        .date-badge { color: var(--date-badge); border-color: rgba(255, 64, 129, 0.3); }
        .badge-icon { width: 9px; height: 9px; fill: currentColor; }
        
        .done-btn { background: rgba(0, 230, 118, 0.1); border: 1px solid var(--success); color: var(--success); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px; }
        .done-btn svg { width: 14px; height: 14px; fill: currentColor; }

        /* 2. CALENDAR */
        #view-calendar { padding: 15px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .month-label { font-size: 16px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 2px; }
        .cal-nav-btn { background: #222; border: 1px solid #444; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 20px; }
        .day-name { text-align: center; font-size: 10px; color: #666; font-weight: bold; margin-bottom: 5px; }
        .day-cell { aspect-ratio: 1; background: #151515; border-radius: 10px; border: 1px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: #888; cursor: pointer; position: relative; }
        .day-cell.today { border-color: var(--accent); color: var(--accent); background: rgba(41, 121, 255, 0.1); }
        .day-cell.has-task::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: #FF4081; border-radius: 50%; }
        .day-cell.selected { background: var(--accent); color: white; border-color: var(--accent); }
        .calendar-tasks-list { border-top: 1px solid #333; padding-top: 15px; }
        .cal-list-title { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 2px; }

        /* 3. FOCUS (GRILLE) */
        #view-focus { padding: 15px; }
        .focus-title { text-align: center; font-weight: 900; color: var(--accent); margin-bottom: 20px; letter-spacing: 2px; font-size: 12px; }
        .focus-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-bottom: 100px; }
        .focus-card { background: #151515; border: 1px solid #333; border-radius: 16px; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 10px; cursor: pointer; transition: all 0.2s; }
        .focus-card:active { transform: scale(0.95); background: #222; border-color: var(--accent); }
        .focus-icon { font-size: 28px; margin-bottom: 10px; filter: grayscale(1); }
        .focus-text { font-size: 12px; font-weight: bold; color: #BBB; line-height: 1.3; }
        
        .laser-container { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 20px; animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .laser-task { font-size: 26px; font-weight: 900; color: white; margin-bottom: 30px; text-shadow: 0 0 20px rgba(41, 121, 255, 0.5); }
        .laser-ai-box { background: rgba(0, 230, 118, 0.05); border: 1px solid var(--success); padding: 20px; border-radius: 16px; width: 100%; margin-bottom: 40px; }
        .laser-ai-label { color: var(--success); font-size: 9px; font-weight: 900; display: block; margin-bottom: 5px; }
        .laser-ai-text { font-size: 16px; font-style: italic; color: #DDD; }
        .laser-btn { background: var(--success); color: black; border: none; padding: 20px 50px; border-radius: 50px; font-weight: 900; font-size: 16px; box-shadow: 0 0 30px rgba(0, 230, 118, 0.3); }
        .laser-back { margin-top: 30px; background: transparent; border: none; color: #666; text-decoration: underline; font-size: 11px; cursor: pointer; }

        /* 4. ROUTINES */
        .routine-container { display: flex; flex-direction: column; padding: 20px 10px; gap: 15px; }
        .routine-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .routine-card-item { background: var(--bg-card); border: 1px solid #333; padding: 20px; border-radius: 16px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; position: relative; transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .routine-delete-btn { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: rgba(0,0,0,0.3); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .routine-icon { font-size: 32px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }
        .routine-name { font-weight: 800; font-size: 14px; text-transform: uppercase; }
        .active-routine-view { display: none; flex-direction: column; height: 100%; }
        .routine-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { background: transparent; border: none; color: #888; font-size: 12px; cursor: pointer; font-weight: bold; }
        .read-routine-btn { background: rgba(41, 121, 255, 0.1); color: var(--accent); border: 1px solid var(--accent); padding: 5px 10px; border-radius: 15px; font-size: 10px; font-weight: bold; }
        .delete-step-btn { background: rgba(255, 23, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .delete-step-btn svg { width: 14px; height: 14px; fill: currentColor; }

        /* 5. POMO */
        .pomo-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center; }
        .pomo-timer { font-size: 80px; font-weight: 900; color: var(--text-main); font-variant-numeric: tabular-nums; margin: 20px 0; text-shadow: 0 0 30px rgba(41, 121, 255, 0.3); }
        .pomo-controls { display: flex; gap: 20px; }
        .pomo-btn { padding: 15px 30px; border-radius: 30px; font-weight: bold; border: none; cursor: pointer; font-size: 18px; }
        .btn-start { background: var(--success); color: black; box-shadow: 0 0 20px rgba(0, 230, 118, 0.4); }
        .btn-stop { background: #333; color: white; }

        /* --- BOTTOM CONTROLS & FOOTER --- */
        .bottom-controls { background: linear-gradient(to top, #121212 90%, transparent); padding-bottom: 40px; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; z-index: 50; padding-left:30px; }
        
        .mode-selector { display: flex; gap: 5px; overflow-x: auto; padding: 5px 10px; margin-bottom: 15px; width: 100%; justify-content: space-between; }
        .mode-card { background: var(--bg-card); padding: 8px 4px; border-radius: 12px; flex: 1; min-width: 0; text-align: center; border: 1px solid transparent; opacity: 0.5; cursor: pointer; }
        .mode-card.active { opacity: 1; border-color: var(--accent); background: rgba(41, 121, 255, 0.1); transform: translateY(-3px); }
        .mode-icon { font-size: 18px; display: block; margin-bottom: 2px; }
        .mode-label { font-size: 9px; font-weight: 700; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* FOOTER UNIFI√â (Clavier et Micro c√¥te √† c√¥te) */
        .footer-actions { display: flex; gap: 20px; align-items: center; justify-content: center; height: 80px; width: 100%; position: relative; }
        
        /* Boutons de m√™me taille */
        .action-circle { 
            width: 55px; height: 55px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: all 0.2s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .btn-keyboard { background: #222; border: 1px solid #444; color: #888; }
        .btn-keyboard.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .btn-mic { background: var(--bg-card); border: 2px solid var(--accent); }
        .btn-mic svg { width: 24px; height: 24px; fill: white; }
        .btn-mic.recording { border-color: var(--danger); background: #330000; box-shadow: 0 0 20px var(--danger); }
        .btn-mic.recording svg { fill: var(--danger); }

        .text-input-container { position: absolute; bottom: 80px; left: 20px; right: 20px; background: var(--bg-card); border: 1px solid var(--accent); border-radius: 30px; padding: 10px 15px; display: none; align-items: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); z-index: 60; }
        .text-input-container.show { display: flex; }
        .text-input { flex: 1; background: transparent; border: none; color: white; font-size: 16px; outline: none; }
        .send-btn { background: var(--accent); border: none; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; margin-left: 10px; }

        /* ONBOARDING */
        .onboarding-overlay, .zen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .onboarding-overlay.show, .zen-overlay.show { display: flex; animation: fadeIn 0.5s; }
        .name-input { background: #222; border: 2px solid #444; color: white; padding: 15px; border-radius: 12px; font-size: 18px; text-align: center; margin-bottom: 20px; outline: none; width: 80%; }
        .save-name-btn { background: var(--accent); color: white; padding: 15px 40px; border-radius: 30px; font-weight: bold; border: none; font-size: 16px; }
        .zen-circle { width: 100px; height: 100px; border-radius: 50%; background: var(--success); box-shadow: 0 0 50px var(--success); margin-bottom: 20px; animation: breathe 4s infinite ease-in-out; }
    </style>
</head>
<body>

    <div id="onboarding-modal" class="onboarding-overlay">
        <div style="font-size:24px; font-weight:900; margin-bottom:20px; color:var(--accent);">Comment t'appelles-tu ?</div>
        <input type="text" id="username-input" class="name-input" placeholder="Ton pr√©nom...">
        <button class="save-name-btn" onclick="saveUsername()">C'est parti !</button>
    </div>

    <div id="zen-popup" class="zen-overlay" onclick="closeZen()">
        <div class="zen-circle"></div><div class="zen-text">ESPRIT LIBRE</div>
    </div>

    <div class="capacity-sidebar">
        <div class="capacity-track"><div id="capacity-bar" class="capacity-fill"></div></div>
    </div>

    <div class="header">
        <div class="header-content">
            <div class="app-logo-container">
                <svg class="app-logo-svg" viewBox="0 0 200 130" xmlns="http://www.w3.org/2000/svg">
                    <defs><filter id="glow"><feGaussianBlur stdDeviation="2.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
                    <path class="brain-pulse" d="M60 40 Q40 40 35 60 T35 90 Q40 110 60 110 L90 110" stroke="#2979FF" stroke-width="2" fill="none" stroke-linecap="round" filter="url(#glow)"/>
                    <path class="brain-pulse" d="M140 40 Q160 40 165 60 T165 90 Q160 110 140 110 L110 110" stroke="#2979FF" stroke-width="2" fill="none" stroke-linecap="round" filter="url(#glow)"/>
                    <path d="M60 55 L80 55 L90 70" stroke="#00E676" stroke-width="2" fill="none" opacity="0.8"/>
                    <path d="M140 55 L120 55 L110 70" stroke="#00E676" stroke-width="2" fill="none" opacity="0.8"/>
                    <circle cx="90" cy="70" r="3" fill="#2979FF"/><circle cx="110" cy="70" r="3" fill="#2979FF"/>
                    <line x1="90" y1="70" x2="110" y2="70" stroke="#2979FF" stroke-width="2"/>
                    <text x="100" y="130" font-family="'Inter', sans-serif" font-weight="900" font-size="20" fill="white" text-anchor="middle" letter-spacing="4">NEURO</text>
                    <text x="100" y="145" font-family="'Inter', sans-serif" font-weight="700" font-size="8" fill="#2979FF" text-anchor="middle" letter-spacing="2">ASSISTANT</text>
                </svg>
            </div>
            
            <div class="header-actions">
                <button id="mood-btn" class="header-btn btn-zen" onclick="toggleMood()"><span>üõ°Ô∏è</span> ZEN</button>
                <button id="sound-btn" class="header-btn btn-audio" onclick="toggleBrownNoise()"><span>üéß</span> FOCUS</button>
                <button class="header-btn btn-brief" onclick="startMorningBrief()"><span>‚òÄÔ∏è</span> BRIEF</button>
            </div>
        </div>
        <div id="monitor-ui" class="monitor-wrapper"><div class="load-track"><div id="load-bar" class="load-fill"></div></div></div>
    </div>

    <div class="content-area">
        <div id="view-dump" class="view-section active">
            <div class="task-container" id="task-list">
                <div style="text-align:center; margin-top:50px; opacity:0.3; font-size:12px;"><p>M√©moire vide.</p></div>
            </div>
        </div>

        <div id="view-calendar" class="view-section">
            <div class="calendar-wrapper">
                <div class="calendar-header">
                    <button class="cal-nav-btn" onclick="changeMonth(-1)">&#8249;</button>
                    <span id="cal-month-label" class="month-label">...</span>
                    <button class="cal-nav-btn" onclick="changeMonth(1)">&#8250;</button>
                </div>
                <div class="calendar-grid">
                    <div class="day-name">L</div><div class="day-name">M</div><div class="day-name">M</div><div class="day-name">J</div><div class="day-name">V</div><div class="day-name">S</div><div class="day-name">D</div>
                    <div id="cal-days-container" style="display:contents"></div>
                </div>
                <div class="calendar-tasks-list">
                    <div class="cal-list-title">T√ÇCHES DU JOUR</div>
                    <div id="cal-task-list" class="task-container" style="padding:0;">
                        <div style="text-align:center; opacity:0.3; font-size:12px;">S√©lectionne un jour.</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-focus" class="view-section">
            <div id="focus-picker-wrapper">
                <div class="focus-title">CHOISIS TA CIBLE</div>
                <div id="focus-grid" class="focus-grid"></div>
            </div>
            <div id="focus-laser-wrapper" class="laser-container">
                <div class="laser-title">MODE LASER ACTIV√â</div>
                <div id="laser-current-task" class="laser-task">...</div>
                <div id="laser-ai-suggestion" class="laser-ai-box" style="display:none">
                    <span class="laser-ai-label">PREMI√àRE √âTAPE</span>
                    <span id="laser-micro-text" class="laser-ai-text">...</span>
                </div>
                <button class="laser-btn" onclick="completeLaserTask()">C'EST FAIT</button>
                <button class="laser-back" onclick="exitLaserMode()">Changer de cible</button>
            </div>
        </div>

        <div id="view-routine" class="view-section">
            <div id="routine-ui" class="routine-container">
                <div id="routines-grid" class="routine-grid"></div>
                <div id="active-routine-view" class="active-routine-view">
                    <div class="routine-header">
                        <button class="back-btn" onclick="exitRoutine()">‚Üê RETOUR</button>
                        <span id="active-routine-name" style="font-weight:bold; color:var(--success);">...</span>
                        <button class="read-routine-btn" onclick="readActiveRoutine()">üîä LIRE</button>
                    </div>
                    <div id="routine-steps-list" class="task-container" style="padding:0;"></div>
                </div>
            </div>
        </div>

        <div id="view-pomo" class="view-section">
            <div id="pomo-ui" class="pomo-container">
                <div class="pomo-status" id="pomo-msg">FOCUS SESSION</div>
                <div class="pomo-timer" id="timer-display">25:00</div>
                <div class="pomo-controls">
                    <button class="pomo-btn btn-stop" onclick="resetTimer()">STOP</button>
                    <button class="pomo-btn btn-start" onclick="toggleTimer()" id="btn-timer-action">START</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-controls">
        <div id="status-text" class="ai-feedback">Pr√™t.</div>
        <div class="mode-selector">
            <div class="mode-card active" onclick="switchView('dump', this)"><span class="mode-icon">üß†</span><span class="mode-label">Vider</span></div>
            <div class="mode-card" onclick="switchView('calendar', this)"><span class="mode-icon">üìÖ</span><span class="mode-label">Cal</span></div>
            <div class="mode-card" onclick="switchView('focus', this)"><span class="mode-icon">‚ö°</span><span class="mode-label">Focus</span></div>
            <div class="mode-card" onclick="switchView('pomo', this)"><span class="mode-icon">‚è≥</span><span class="mode-label">Pomo</span></div>
            <div class="mode-card" onclick="switchView('routine', this)"><span class="mode-icon">üîÑ</span><span class="mode-label">Routine</span></div>
        </div>
        
        <div class="footer-actions">
            <div class="action-circle btn-keyboard" onclick="toggleInputMode(this)">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 5H4c-1.1 0-1.99.9-1.99 2L2 17c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/></svg>
            </div>
            
            <div id="btn-mic" class="action-circle btn-mic" onclick="toggleRecording()">
                <svg id="icon-mic" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                <svg id="icon-stop" viewBox="0 0 24 24" style="display:none"><path d="M6 6h12v12H6z"/></svg>
            </div>
        </div>
        
        <div id="text-input-ui" class="text-input-container">
            <input type="text" id="user-input" class="text-input" placeholder="Je t'√©coute..." onkeypress="handleEnter(event)">
            <button class="send-btn" onclick="sendText()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
    </div>

    <script>
        const API_BASE_URL = "https://boite-adulte.vercel.app";
        const MAKE_WEBHOOK = "https://hook.eu1.make.com/l3agyq8s6bh1qp5vw4pruulekij94fai";

        // DATA & STATE
        let currentMode = 'DUMP';
        let currentMood = 'ZEN';
        let isProcessing = false; isTextMode = false; recognition = null; isRecording = false; finalTranscript = '';
        let timerInterval = null; timeLeft = 25 * 60; isTimerRunning = false;
        let username = "Champion";
        let audioCtx, brownNoiseNode, gainNode, isNoisePlaying = false;
        let currentFocusTask = null;
        let currentCalDate = new Date();

        document.addEventListener('DOMContentLoaded', () => { 
            checkOnboarding(); loadTasks(); updateMentalLoad(); updateDailyCapacity(); renderRoutines(); 
            initSpeech(); loadMood(); if ("Notification" in window) Notification.requestPermission();
            
            // Force Dump View on Start
            switchView('dump', document.querySelector('.mode-card.active'));
        });

        // --- NAVIGATION ---
        function switchView(viewName, btn) {
            document.querySelectorAll('.mode-card').forEach(el => el.classList.remove('active')); if(btn) btn.classList.add('active');
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            const monitor = document.getElementById('monitor-ui');
            if (viewName === 'dump' || viewName === 'focus') monitor.classList.remove('hidden'); else monitor.classList.add('hidden');

            currentMode = viewName.toUpperCase();
            if (viewName === 'focus') renderFocusGrid();
            if (viewName === 'calendar') renderCalendar();
            
            const titles = {'dump': "Je note...", 'calendar': "Agenda", 'focus': "Mode Laser", 'routine': "Biblioth√®que", 'pomo': "Timer"};
            document.getElementById('status-text').innerText = titles[viewName];
        }

        // --- CORE FUNCTIONS ---
        function addTaskToUI(text, type, priority='NORMAL', duration=15, date=null) {
            const list = document.getElementById('task-list');
            if(list.innerText.includes("M√©moire vide")) list.innerHTML = "";
            const div = document.createElement('div');
            const isCal = (type === 'CALENDAR'); const isRem = (type === 'REMINDER'); const isHigh = (priority === 'HIGH');
            div.className = `task-item ${isCal ? 'calendar' : ''} ${isRem ? 'reminder' : ''} ${isHigh ? 'priority-high' : ''}`;
            div.setAttribute('data-duration', duration);
            if(date) div.setAttribute('data-date', date);
            const syncIcon = isCal ? '<span class="sync-badge">üìÖ</span>' : ''; const remIcon = isRem ? '<span class="reminder-badge">üîî</span>' : ''; const fireIcon = isHigh ? '<span class="priority-badge">üî•</span>' : '';
            let dateBadge = ''; if(date) { const dObj = new Date(date); dateBadge = `<span class="date-badge"><svg class="badge-icon" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg> ${dObj.getDate()}/${dObj.getMonth()+1}</span>`; }
            const timeBadge = `<span class="time-badge"><svg class="badge-icon" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg> ${duration}m</span>`;
            
            // CATEGORIE FLAMME
            let cat = isCal ? 'AGENDA' : (isRem ? 'RAPPEL' : (isHigh ? 'URGENT üî•' : 'T√ÇCHE'));

            div.innerHTML = `<div class="task-content"><div class="task-text">${text} ${syncIcon} ${remIcon} ${fireIcon}</div><div class="task-sub">${dateBadge} ${timeBadge} <span style="color:${(isCal||isRem) ? '#FF8A80' : '#888'}">${cat}</span></div></div><div class="actions-group"><button class="done-btn" onclick="completeTask(this)"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></button></div>`;
            list.appendChild(div); saveTasks(); updateMentalLoad(); updateDailyCapacity();
        }

        async function processWithAI(userInput) {
            isProcessing = true; document.getElementById('status-text').innerText = "R√©fl√©chit..."; 
            const currentPrompts = getPrompts(); const finalPrompt = `${currentPrompts[currentMode]}\n\nUTILISATEUR : "${userInput}"`;
            try {
                const rep = await fetch(`${API_BASE_URL}/api/gemini`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: finalPrompt }) });
                const data = await rep.json();
                let parsed = JSON.parse(data.text.replace(/```json/g, '').replace(/```/g, '').trim());
                if (currentMode === 'ROUTINE') { if (parsed.command === 'SAVE_ROUTINE') { saveRoutine(parsed.name, parsed.steps); playVocalResponse(`Routine ${parsed.name} enregistr√©e.`); isProcessing = false; return; } else if (parsed.command === 'GET_ROUTINE') { const savedSteps = JSON.parse(localStorage.getItem('neuro_routines') || '{}')[parsed.name.toLowerCase()]; if (savedSteps) { launchRoutine(parsed.name); playVocalResponse(`Voici ta routine.`); } else { playVocalResponse(`Inconnue.`); } isProcessing = false; return; } }
                if(parsed.actions) { parsed.actions.forEach(act => { addTaskToUI(act.detail, act.type, act.priority || 'NORMAL', act.duration, act.due_date); if(act.type === 'CALENDAR' || act.type === 'REMINDER') sendToCalendar(act.detail); }); }
                playVocalResponse(parsed.text);
            } catch (e) { console.error(e); document.getElementById('status-text').innerText = "Erreur"; isProcessing = false; }
        }

        function getPrompts() {
            const today = new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            let tone = (currentMood === 'ZEN') ? "Ton: Doux, lent." : "Ton: Dynamique.";
            return {
                'DUMP': `Assistant TDAH pour ${username}. ${tone}. DATE: ${today}. JSON Strict. Champ "text": 1 mot court. Actions: [ { "type": "TODO/CALENDAR/REMINDER", "detail": "...", "priority": "NORMAL/HIGH", "duration": 15, "due_date": "YYYY-MM-DD" } ]. ESTIME LA DUR√âE (en min). SI DATE, mets dans "due_date".`,
                'FOCUS': `Coach TDAH. Mission: D√©dramatise. JSON Strict: { "text": "...", "actions": [] }`,
                'ROUTINE': `Expert. ${tone}. Commandes: SAVE_ROUTINE/GET_ROUTINE.`,
                'POMO': `Coach Pomodoro. ${tone}. JSON Strict: { "text": "Focus ?", "actions": [] }`
            };
        }

        // --- BUTTONS & ACTIONS ---
        function toggleMood() { currentMood = (currentMood === 'ZEN') ? 'BOOST' : 'ZEN'; localStorage.setItem('neuro_mood', currentMood); updateMoodUI(); playVocalResponse(currentMood === 'ZEN' ? "Mode Zen." : "Mode Boost !"); }
        function updateMoodUI() { const btn = document.getElementById('mood-btn'); if(currentMood === 'ZEN') { btn.className = "header-btn btn-zen active"; btn.innerHTML = "<span>üõ°Ô∏è</span> ZEN"; } else { btn.className = "header-btn btn-boost active"; btn.innerHTML = "<span>üöÄ</span> BOOST"; } }
        function loadMood() { const saved = localStorage.getItem('neuro_mood'); if(saved) { currentMood = saved; updateMoodUI(); } }
        function toggleBrownNoise() { if (isNoisePlaying) stopBrownNoise(); else startBrownNoise(); }
        function startBrownNoise() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); const bufferSize = 4096; const brownNoise = audioCtx.createScriptProcessor(bufferSize, 1, 1); brownNoise.onaudioprocess = function(e) { const output = e.outputBuffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) { const white = Math.random() * 2 - 1; output[i] = (lastOut + (0.02 * white)) / 1.02; lastOut = output[i]; output[i] *= 3.5; } }; let lastOut = 0; gainNode = audioCtx.createGain(); gainNode.gain.value = 0.15; brownNoise.connect(gainNode); gainNode.connect(audioCtx.destination); brownNoiseNode = brownNoise; isNoisePlaying = true; const btn = document.getElementById('sound-btn'); btn.classList.add('active'); btn.innerHTML = `<span>üéß</span> FOCUS <span class="sound-wave"></span>`; }
        function stopBrownNoise() { if (brownNoiseNode) { brownNoiseNode.disconnect(); brownNoiseNode = null; } isNoisePlaying = false; const btn = document.getElementById('sound-btn'); btn.classList.remove('active'); btn.innerHTML = `<span>üéß</span> FOCUS`; }

        // --- CALENDAR & FOCUS & ROUTINES (Standard JS Logic) ---
        function renderCalendar() {
            const container = document.getElementById('cal-days-container');
            const monthLabel = document.getElementById('cal-month-label');
            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();
            const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
            monthLabel.innerText = `${monthNames[month]} ${year}`;
            container.innerHTML = "";
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const offset = (firstDay === 0) ? 6 : firstDay - 1;
            for(let i=0; i<offset; i++) container.appendChild(document.createElement('div'));
            const tasks = [];
            document.querySelectorAll('.task-item').forEach(item => { const dateAttr = item.getAttribute('data-date'); if(dateAttr) tasks.push({ date: dateAttr, html: item.outerHTML }); });
            for(let d=1; d<=daysInMonth; d++) {
                const dayDiv = document.createElement('div'); dayDiv.className = "day-cell"; dayDiv.innerText = d;
                const currentDateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const today = new Date(); if(d === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayDiv.classList.add('today');
                const dayTasks = tasks.filter(t => t.date === currentDateStr);
                if(dayTasks.length > 0) dayDiv.classList.add('has-task');
                dayDiv.onclick = () => { document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected')); dayDiv.classList.add('selected'); showTasksForDay(dayTasks, d, monthNames[month]); };
                container.appendChild(dayDiv);
            }
        }
        function changeMonth(delta) { currentCalDate.setMonth(currentCalDate.getMonth() + delta); renderCalendar(); }
        function showTasksForDay(tasks, day, monthName) {
            const list = document.getElementById('cal-task-list');
            if(tasks.length === 0) { list.innerHTML = `<div style="text-align:center; opacity:0.5; font-size:12px;">Rien de pr√©vu le ${day} ${monthName}.</div>`; } 
            else { list.innerHTML = ""; tasks.forEach(t => { const div = document.createElement('div'); div.innerHTML = t.html; const btn = div.querySelector('.done-btn'); if(btn) btn.style.display='none'; list.appendChild(div.firstChild); }); }
        }

        function renderFocusGrid() {
            const grid = document.getElementById('focus-grid'); const tasksHTML = document.getElementById('task-list').innerHTML;
            document.getElementById('focus-picker-wrapper').style.display = 'block'; document.getElementById('focus-laser-wrapper').style.display = 'none';
            if (tasksHTML.includes("M√©moire vide")) { grid.innerHTML = `<div style="text-align:center; opacity:0.5; grid-column:span 2; margin-top:40px;">Aucune cible.</div>`; return; }
            grid.innerHTML = ""; const tempDiv = document.createElement('div'); tempDiv.innerHTML = tasksHTML;
            tempDiv.querySelectorAll('.task-item').forEach(item => { const text = item.querySelector('.task-text').innerText; const div = document.createElement('div'); div.className = "focus-card"; div.innerHTML = `<span class="focus-icon">üéØ</span><span class="focus-text">${text}</span>`; div.onclick = () => activateLaserMode(text); grid.appendChild(div); });
        }
        async function activateLaserMode(taskText) {
            currentFocusTask = taskText; document.getElementById('focus-picker-wrapper').style.display = 'none'; document.getElementById('focus-laser-wrapper').style.display = 'flex'; document.getElementById('laser-current-task').innerText = taskText; document.getElementById('laser-ai-suggestion').style.display = 'none'; document.getElementById('status-text').innerText = "Analyse...";
            try { const prompt = `Coach TDAH. T√¢che: "${taskText}". Donne UNE SEULE micro-√©tape ridicule.`; const rep = await fetch(`${API_BASE_URL}/api/gemini`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: prompt }) }); const data = await rep.json(); document.getElementById('laser-micro-text').innerText = data.text.replace(/\*/g, ''); document.getElementById('laser-ai-suggestion').style.display = 'block'; playVocalResponse(`Cible verrouill√©e. ${data.text}`); } catch(e) {}
        }
        function completeLaserTask() { triggerConfetti(); playVocalResponse("Bravo !"); const list = document.getElementById('task-list'); const items = list.querySelectorAll('.task-item'); items.forEach(item => { if(item.querySelector('.task-text').innerText.includes(currentFocusTask)) item.remove(); }); saveTasks(); updateMentalLoad(); updateDailyCapacity(); setTimeout(exitLaserMode, 2000); }
        function exitLaserMode() { document.getElementById('focus-laser-wrapper').style.display = 'none'; document.getElementById('focus-picker-wrapper').style.display = 'block'; renderFocusGrid(); }

        function getRoutineStyle(name) { 
            const n = name.toLowerCase(); 
            if (n.includes('matin') || n.includes('reveil')) return { icon: '‚òÄÔ∏è', color: '#FFD740', bg: 'rgba(255, 215, 64, 0.1)' }; 
            if (n.includes('soir') || n.includes('nuit')) return { icon: 'üåô', color: '#536DFE', bg: 'rgba(83, 109, 254, 0.1)' }; 
            if (n.includes('sport') || n.includes('gym')) return { icon: 'üí™', color: '#FF4081', bg: 'rgba(255, 64, 129, 0.1)' }; 
            if (n.includes('travail') || n.includes('boulot')) return { icon: 'üíº', color: '#00E5FF', bg: 'rgba(0, 229, 255, 0.1)' }; 
            if (n.includes('maison')) return { icon: 'üè†', color: '#00E676', bg: 'rgba(0, 230, 118, 0.1)' }; 
            return { icon: '‚ö°', color: '#BB86FC', bg: 'rgba(187, 134, 252, 0.1)' }; 
        }
        function renderRoutines() { 
            const grid = document.getElementById('routines-grid'); 
            const routines = JSON.parse(localStorage.getItem('neuro_routines') || '{}'); 
            grid.innerHTML = ""; 
            if (Object.keys(routines).length === 0) { grid.innerHTML = `<div style="grid-column:span 2; opacity:0.5; font-size:12px; text-align:center;">Aucune routine.<br>Dis "Cr√©e routine..."</div>`; return; }
            for (let name in routines) { 
                const btn = document.createElement('div'); btn.className = "routine-card-item"; const style = getRoutineStyle(name); 
                btn.style.borderLeft = `4px solid ${style.color}`; btn.style.background = `linear-gradient(135deg, ${style.bg}, var(--bg-card))`;
                btn.innerHTML = `<span class="routine-icon">${style.icon}</span><span class="routine-name">${name}</span><div class="routine-delete-btn" onclick="deleteRoutine('${name}', event)">‚úï</div>`; 
                btn.onclick = () => launchRoutine(name); grid.appendChild(btn); 
            } 
        }
        
        // --- HELPER FUNCTIONS ---
        function completeTask(btn) { const item = btn.closest('.task-item'); if(item) { item.style.transform="translateX(100%)"; item.style.opacity="0"; setTimeout(()=>{ item.remove(); saveTasks(); updateMentalLoad(); updateDailyCapacity(); }, 300); } }
        function saveTasks() { localStorage.setItem('neuro_tasks', document.getElementById('task-list').innerHTML); }
        function loadTasks() { const s = localStorage.getItem('neuro_tasks'); if(s && s.trim()!=="") document.getElementById('task-list').innerHTML = s; }
        function updateMentalLoad() { const items = document.querySelectorAll('#task-list .task-item'); let score = 0; items.forEach(i => { if(i.classList.contains('priority-high')) score+=3; else score+=1; }); const p = Math.min((score/12)*100, 100); document.getElementById('load-bar').style.width = p+"%"; }
        function updateDailyCapacity() { const items = document.querySelectorAll('#task-list .task-item'); let mins = 0; items.forEach(i => { mins += parseInt(i.getAttribute('data-duration')) || 15; }); const p = Math.min((mins/360)*100, 100); document.getElementById('capacity-bar').style.height = p+"%"; }
        function checkOnboarding() { const savedName = localStorage.getItem('neuro_username'); if (savedName) { username = savedName; } else { document.getElementById('onboarding-modal').classList.add('show'); } }
        function saveUsername() { const input = document.getElementById('username-input'); if (input.value.trim() !== "") { username = input.value.trim(); localStorage.setItem('neuro_username', username); document.getElementById('onboarding-modal').classList.remove('show'); } }
        function cleanTextForSpeech(text) { if(!text) return ""; return text.replace(/[*#]/g, '').replace(/^- /g, ''); }
        function initSpeech() { const Speech = window.SpeechRecognition || window.webkitSpeechRecognition; if (!Speech) return; recognition = new Speech(); recognition.lang = 'fr-FR'; recognition.continuous = true; recognition.interimResults = true; recognition.onresult = (event) => { for (let i = event.resultIndex; i < event.results.length; ++i) { if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript + ' '; } }; recognition.onerror = (e) => { stopRecordingState(); }; }
        function toggleRecording() { if (isProcessing) { isProcessing = false; } if (!isRecording) { finalTranscript = ''; try { recognition.start(); isRecording = true; document.getElementById('btn-mic').classList.add('recording'); document.getElementById('status-text').innerText = "J'√©coute..."; } catch(e) { recognition.stop(); isRecording = false; } } else { recognition.stop(); isRecording = false; document.getElementById('btn-mic').classList.remove('recording'); document.getElementById('status-text').innerText = "Attente fin..."; setTimeout(() => { if(finalTranscript.trim().length > 0) { processWithAI(finalTranscript); } else { document.getElementById('status-text').innerText = "Rien entendu."; } }, 800); } }
        function stopRecordingState() { isRecording = false; document.getElementById('btn-mic').classList.remove('recording'); document.getElementById('status-text').innerText = "Erreur Micro"; }
        async function playVocalResponse(txt) { document.getElementById('status-text').innerText = "Pr√™t."; isProcessing = false; const u = new SpeechSynthesisUtterance(cleanTextForSpeech(txt)); u.lang='fr-FR'; u.rate = (currentMood === 'ZEN') ? 0.85 : 1.1; window.speechSynthesis.speak(u); }
        async function sendToCalendar(detail) { try { await fetch(MAKE_WEBHOOK, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ detail: detail, type: 'CALENDAR' }) }); } catch (e) {} }
        function saveRoutine(n, s) { let r = JSON.parse(localStorage.getItem('neuro_routines') || '{}'); r[n.toLowerCase()] = s; localStorage.setItem('neuro_routines', JSON.stringify(r)); renderRoutines(); }
        function deleteRoutine(n, e) { if(e) e.stopPropagation(); if(confirm("Supprimer ?")) { let r = JSON.parse(localStorage.getItem('neuro_routines') || '{}'); delete r[n]; localStorage.setItem('neuro_routines', JSON.stringify(r)); renderRoutines(); } }
        function deleteStepFromRoutine(n, i) { let r = JSON.parse(localStorage.getItem('neuro_routines') || '{}'); const k = Object.keys(r).find(x => x === n.toLowerCase()); if (k) { r[k].splice(i, 1); localStorage.setItem('neuro_routines', JSON.stringify(r)); launchRoutine(n); } }
        function launchRoutine(n) { const r = JSON.parse(localStorage.getItem('neuro_routines') || '{}'); const s = r[n.toLowerCase()]; if(!s) return; document.getElementById('routines-grid').style.display='none'; document.getElementById('active-routine-view').style.display='flex'; document.getElementById('active-routine-name').innerText=n; const l = document.getElementById('routine-steps-list'); l.innerHTML=""; s.forEach((step, i)=>{ const d=document.createElement('div'); d.className="task-item"; d.innerHTML=`<div class="task-text" contenteditable="true">${step}</div><div class="actions-group"><button class="delete-step-btn" onclick="deleteStepFromRoutine('${n}', ${i})">X</button><button class="done-btn" onclick="this.parentElement.parentElement.remove(); checkRoutineFinish()">V</button></div>`; l.appendChild(d); }); }
        function readActiveRoutine() { const l=document.getElementById('routine-steps-list'); let t=`Routine ${document.getElementById('active-routine-name').innerText}. `; l.querySelectorAll('.task-text').forEach(e=>t+=e.innerText+". "); playVocalResponse(t); }
        function checkRoutineFinish() { if(document.getElementById('routine-steps-list').children.length===0) { playVocalResponse("Termin√© !"); exitRoutine(); } }
        function exitRoutine() { document.getElementById('routines-grid').style.display='grid'; document.getElementById('active-routine-view').style.display='none'; }
        function toggleInputMode(btn) { isTextMode = !isTextMode; const textUI = document.getElementById('text-input-ui'); if(isTextMode) { textUI.classList.add('show'); btn.classList.add('active'); document.getElementById('user-input').focus(); } else { textUI.classList.remove('show'); btn.classList.remove('active'); } }
        function handleEnter(e) { if(e.key === 'Enter') sendText(); }
        function sendText() { const input = document.getElementById('user-input'); if(input.value.trim()){ processWithAI(input.value); input.value=""; } }
        function updateTimerDisplay() { document.getElementById('timer-display').innerText = `${Math.floor(timeLeft / 60).toString().padStart(2, '0')}:${(timeLeft % 60).toString().padStart(2, '0')}`; }
        function toggleTimer() { const btn = document.getElementById('btn-timer-action'); if (isTimerRunning) { clearInterval(timerInterval); isTimerRunning = false; btn.innerText = "REPRENDRE"; btn.style.background = "#FFB74D"; } else { timerInterval = setInterval(() => { timeLeft--; updateTimerDisplay(); if (timeLeft <= 0) { clearInterval(timerInterval); playVocalResponse("Fini !"); triggerConfetti(); } }, 1000); isTimerRunning = true; btn.innerText = "PAUSE"; btn.style.background = "transparent"; btn.style.border = "1px solid #666"; btn.style.color = "#888"; } }
        function resetTimer() { clearInterval(timerInterval); isTimerRunning = false; timeLeft = 25 * 60; updateTimerDisplay(); const btn = document.getElementById('btn-timer-action'); btn.innerText = "START"; btn.style.background = "var(--success)"; btn.style.color = "black"; }
        function closeZen() { document.getElementById('zen-popup').classList.remove('show'); }
        function triggerConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        async function startMorningBrief() {
            if(isProcessing) return; isProcessing = true;
            const tasksList = []; document.querySelectorAll('#task-list .task-text').forEach(el => tasksList.push(el.innerText));
            const tasksString = tasksList.length > 0 ? tasksList.join(", ") : "Rien";
            const today = new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            const briefPrompt = `Assistant TDAH pour ${username}. Date: ${today}. T√¢ches: ${tasksString}. Brief (30s). 1. Bonjour ${username} 2. Charge 3. Priorit√©.`;
            try {
                const rep = await fetch(`${API_BASE_URL}/api/gemini`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: briefPrompt }) });
                const data = await rep.json();
                playVocalResponse(data.text);
            } catch(e) { isProcessing = false; }
        }
    </script>
</body>
</html>