<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLARIS v3.3</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- GESTION DES TH√àMES (DARK / LIGHT) --- */
        :root { 
            /* COULEURS DARK (D√©faut) */
            --bg-main: #121212; 
            --bg-card: #1E1E1E; 
            --bg-input: #222;
            --text-main: #E0E0E0;
            --text-muted: #888;
            --border: #333;
            --gradient-overlay: linear-gradient(to top, #121212 90%, transparent);
            
            /* ACCENTS (Communs) */
            --accent: #2979FF; 
            --success: #00E676; 
            --warning: #FFAB00; 
            --danger: #FF1744; 
            --calendar: #D500F9; 
            --capacity: #00E5FF; 
            --date-badge: #FF4081;
        }

        /* TH√àME CLAIR (Activ√© via data-theme="light" sur le body) */
        [data-theme="light"] {
            --bg-main: #F2F2F7; /* Gris Apple tr√®s clair */
            --bg-card: #FFFFFF; /* Blanc pur */
            --bg-input: #E5E5EA;
            --text-main: #1C1C1E; /* Presque noir */
            --text-muted: #8E8E93;
            --border: #D1D1D6;
            --gradient-overlay: linear-gradient(to top, #F2F2F7 90%, transparent);
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
            margin: 0; 
            touch-action: none; 
            display: flex; 
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* HEADER */
        .header { background: var(--bg-main); z-index: 50; border-bottom: 1px solid var(--border); padding: 15px 15px 10px 15px; flex-shrink: 0; transition: background 0.3s; }
        .header-top { display: flex; align-items: center; justify-content: space-between; height: 50px; }
        
        /* LOGO CLARIS */
        .app-logo-container { display: flex; align-items: center; gap: 12px; }
        .logo-point-wrapper { position: relative; width: 12px; height: 12px; display: flex; }
        .logo-point-ping { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: var(--accent); opacity: 0.75; animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite; }
        .logo-point-solid { position: relative; width: 12px; height: 12px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 15px var(--accent); }
        .logo-text { font-weight: 900; font-size: 20px; color: var(--text-main); letter-spacing: 3px; font-family: 'Inter', sans-serif; }
        .version-tag { font-size: 9px; color: var(--text-muted); font-weight: bold; margin-left: 5px; border: 1px solid var(--border); padding: 2px 4px; border-radius: 4px; }
        
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }

        .header-actions { display: flex; gap: 8px; }
        .header-btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted); font-size: 10px; font-weight: bold; padding: 6px 10px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .mood-btn.active.zen { border-color: var(--success); color: var(--success); background: rgba(0, 230, 118, 0.1); }
        .mood-btn.active.boost { border-color: var(--danger); color: var(--danger); background: rgba(255, 23, 68, 0.1); }
        .sound-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(41, 121, 255, 0.1); box-shadow: 0 0 10px rgba(41, 121, 255, 0.2); }
        .sound-wave { display: inline-block; height: 10px; width: 2px; background: currentColor; animation: sound 1.5s infinite ease-in-out; margin-left:2px; }
        @keyframes sound { 0%, 100% { height: 3px; opacity:0.6; } 50% { height: 10px; opacity:1; } }
        .brief-btn { background: rgba(255, 171, 0, 0.1); border: 1px solid var(--warning); color: var(--warning); }
        .brief-btn.loading { background: var(--warning); color: black; box-shadow: 0 0 15px rgba(255, 171, 0, 0.4); animation: pulseWarning 1s infinite; }
        @keyframes pulseWarning { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }

        /* MONITOR & SIDEBAR */
        .monitor-bar-container { width: 100%; height: 8px; background: var(--bg-input); flex-shrink: 0; position: relative; border-bottom: 1px solid var(--border); }
        .load-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00E676 0%, #FFAB00 60%, #FF1744 100%); transition: width 0.6s ease-out; box-shadow: 0 0 15px rgba(0, 230, 118, 0.2); }
        .capacity-sidebar { position: fixed; left: 0; top: 80px; bottom: 90px; width: 10px; background: var(--bg-main); border-right: 1px solid var(--border); z-index: 40; }
        .capacity-fill { width: 100%; height: 0%; background: var(--capacity); position: absolute; bottom: 0; left: 0; transition: height 0.6s; opacity: 0.8; }

        /* CONTENT */
        .content-area { flex: 1; overflow-y: auto; position: relative; scrollbar-width: none; padding-left: 15px; padding-top: 10px; }
        .view-section { display: none; height: 100%; flex-direction: column; width: 100%; }
        .view-section.active { display: flex; animation: fadeIn 0.3s ease-out; }

        /* --- STYLES DES T√ÇCHES --- */
        .task-container { padding: 10px 10px 100px 10px; display: flex; flex-direction: column; gap: 10px; }
        
        .task-item { 
            background: var(--bg-card); 
            padding: 12px 15px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border-left: 3px solid var(--accent);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            transition: all 0.2s; 
            border: 1px solid transparent;
        }
        /* Bordure l√©g√®re en mode clair pour d√©tacher du fond */
        [data-theme="light"] .task-item { border: 1px solid #E5E5E5; }

        .task-item.priority-high { 
            border-left-color: var(--danger); 
            background: linear-gradient(90deg, rgba(255, 23, 68, 0.1), var(--bg-card)); 
            order: -3; 
        }

        .task-item.calendar { 
            border-left-color: var(--calendar); 
            background: linear-gradient(90deg, rgba(213, 0, 249, 0.1), var(--bg-card)); 
            order: -2; 
        }

        .task-item.reminder { 
            border-left-color: var(--reminder); 
            order: -1; 
        }

        .task-text { font-size: 14px; font-weight: 500; outline: none; flex: 1; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
        .task-sub { font-size: 9px; opacity: 0.7; text-transform: uppercase; margin-top: 3px; display: flex; gap: 6px; align-items: center; color: var(--text-muted); }
        
        .time-badge, .date-badge { background: var(--bg-input); padding: 1px 5px; border-radius: 4px; font-weight: bold; font-size: 9px; display: flex; align-items: center; gap: 3px; border: 1px solid var(--border); }
        .time-badge { color: var(--capacity); border-color: rgba(0, 229, 255, 0.3); }
        .date-badge { color: var(--date-badge); border-color: rgba(255, 64, 129, 0.3); }
        
        .badge-icon { width: 9px; height: 9px; fill: currentColor; }
        .priority-icon { color: var(--danger); font-size:12px; animation: pulse 2s infinite; }
        .bell-active { color: var(--warning); animation: ring 4s infinite; }
        @keyframes ring { 0% { transform: rotate(0); } 5% { transform: rotate(20deg); } 10% { transform: rotate(-20deg); } 15% { transform: rotate(0); } 100% { transform: rotate(0); } }
        
        .actions-group { display: flex; gap: 10px; align-items: center; margin-left: 10px; }
        .done-btn { background: rgba(0, 230, 118, 0.1); border: 1px solid var(--success); color: var(--success); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .done-btn svg { width: 14px; height: 14px; fill: currentColor; }

        /* CALENDAR GRID */
        #view-calendar { padding: 15px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .month-label { font-size: 16px; font-weight: 900; color: var(--text-main); text-transform: uppercase; letter-spacing: 2px; }
        .cal-nav-btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day-name { text-align: center; font-size: 10px; color: var(--text-muted); font-weight: bold; margin-bottom: 5px; }
        .day-cell { aspect-ratio: 1; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: var(--text-muted); cursor: pointer; position: relative; transition: all 0.2s; }
        .day-cell.today { border-color: var(--accent); color: var(--accent); background: rgba(41, 121, 255, 0.1); }
        .day-cell.has-task { border-color: rgba(255, 23, 68, 0.3); }
        .day-cell.has-task::after { content: ''; position: absolute; bottom: 5px; width: 5px; height: 5px; background: var(--danger); border-radius: 50%; box-shadow: 0 0 5px var(--danger); }
        .day-cell.selected { background: var(--accent); color: white; border-color: var(--accent); transform: scale(1.1); box-shadow: 0 0 15px rgba(41, 121, 255, 0.4); z-index: 10; }
        .calendar-tasks-list { border-top: 1px solid var(--border); padding-top: 15px; margin-top: 20px; }
        .cal-list-title { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 2px; }

        /* FOCUS HUD */
        #view-focus { padding: 15px; }
        .focus-title { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; text-align: center; }
        .focus-grid { display: flex; flex-direction: column; gap: 12px; }
        .focus-chip { display: flex; align-items: center; justify-content: space-between; background: linear-gradient(90deg, rgba(41, 121, 255, 0.05), transparent); border: 1px solid rgba(41, 121, 255, 0.2); border-left: 3px solid var(--accent); padding: 18px 20px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; background-color: var(--bg-card); }
        .focus-chip:active { transform: scale(0.98); background: rgba(41, 121, 255, 0.15); }
        .focus-chip::after { content: ''; position: absolute; top:0; left:0; height:100%; width: 3px; background: var(--accent); box-shadow: 0 0 10px var(--accent); opacity: 0; transition: opacity 0.3s; }
        .focus-chip:hover::after { opacity: 1; }
        .focus-chip-text { font-weight: 600; font-size: 14px; color: var(--text-main); letter-spacing: 0.5px; }
        .focus-chip-action { width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--accent); color: var(--accent); display: flex; align-items: center; justify-content: center; }
        
        .laser-container { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; position: relative; }
        .laser-ring-container { position: relative; width: 260px; height: 260px; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
        .laser-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--accent); opacity: 0.3; animation: ripple 2s infinite; }
        .laser-ring:nth-child(2) { animation-delay: 0.5s; }
        .laser-ring:nth-child(3) { animation-delay: 1s; }
        @keyframes ripple { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.5); opacity: 0; } }
        .laser-task { font-size: 28px; font-weight: 900; line-height: 1.2; z-index: 10; text-shadow: 0 0 20px rgba(0,0,0,0.8); max-width: 90%; color: var(--text-main); }
        /* Ajustement ombre texte en light mode */
        [data-theme="light"] .laser-task { text-shadow: none; color: #000; }

        .laser-btn { background: var(--success); color: black; padding: 15px 40px; border-radius: 30px; font-weight: bold; margin-top: 20px; z-index: 10; box-shadow: 0 0 20px rgba(0, 230, 118, 0.4); border:none; font-size: 16px; }
        .laser-back { margin-top: 30px; background: transparent; border: none; color: var(--text-muted); text-decoration: underline; font-size: 12px; cursor: pointer; z-index: 10; }

        /* ROUTINE */
        #view-routine { padding: 15px; position: relative; height: 100%; }
        .routine-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .routine-card-item { background: var(--bg-card); border: 1px solid var(--border); padding: 20px; border-radius: 16px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; position: relative; transition: all 0.2s; }
        .routine-delete-btn { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: rgba(0,0,0,0.3); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .routine-icon { font-size: 32px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }
        .routine-name { font-weight: 800; font-size: 14px; text-transform: uppercase; color: var(--text-main); }
        
        .active-routine-view { display: none; flex-direction: column; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-main); z-index: 50; padding: 15px; }
        .routine-header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .back-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 5px 10px; border-radius: 8px; font-size: 10px; font-weight: bold; cursor: pointer; }
        .read-routine-btn { background: rgba(41, 121, 255, 0.1); color: var(--accent); border: 1px solid var(--accent); padding: 5px 10px; border-radius: 15px; font-size: 10px; font-weight: bold; }
        .routine-list-scroll { flex: 1; overflow-y: auto; }
        
        .routine-step-item { background: var(--bg-card); padding: 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; border-left: 3px solid #666; border: 1px solid transparent; }
        [data-theme="light"] .routine-step-item { border: 1px solid #ddd; }
        .routine-step-text { text-align: left; font-size: 14px; font-weight: 500; color: var(--text-main); flex: 1; margin-right: 10px; }
        .delete-step-btn { background: rgba(255, 23, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .delete-step-btn svg { width: 14px; height: 14px; fill: currentColor; }
        
        /* POMO */
        .pomo-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center; }
        .pomo-timer { font-size: 80px; font-weight: 900; color: var(--text-main); font-variant-numeric: tabular-nums; margin: 20px 0; text-shadow: 0 0 30px rgba(41, 121, 255, 0.3); }
        [data-theme="light"] .pomo-timer { text-shadow: none; }
        .pomo-controls { display: flex; gap: 20px; }
        .pomo-btn { padding: 15px 30px; border-radius: 30px; font-weight: bold; border: none; cursor: pointer; font-size: 18px; }
        .btn-start { background: var(--success); color: black; box-shadow: 0 0 20px rgba(0, 230, 118, 0.4); }
        .btn-stop { background: #333; color: white; }

        /* TUTO STYLES */
        #view-tuto { padding: 15px; }
        .tuto-card { background: var(--bg-card); border-left: 4px solid #333; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .tuto-title { font-weight: 900; color: var(--text-main); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; font-size: 14px; letter-spacing: 1px; }
        .tuto-desc { font-size: 12px; color: var(--text-muted); line-height: 1.6; }
        .tuto-instruction { background: var(--bg-input); padding: 8px 12px; border-radius: 8px; margin-top: 10px; font-size: 11px; color: var(--accent); font-style: italic; border: 1px solid var(--border); }

        /* FOOTER & CONTROLS */
        .bottom-controls { background: var(--gradient-overlay); padding-bottom: 40px; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; z-index: 50; padding-left:15px; }
        .mode-selector { display: flex; gap: 5px; overflow-x: auto; padding: 5px 10px; margin-bottom: 10px; width: 100%; justify-content: space-between; }
        .mode-card { background: var(--bg-card); padding: 8px 4px; border-radius: 12px; flex: 1; min-width: 0; text-align: center; border: 1px solid transparent; opacity: 0.5; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); }
        .mode-card.active { opacity: 1; border-color: var(--accent); background: rgba(41, 121, 255, 0.1); transform: translateY(-3px); color: var(--text-main); }
        .mode-icon { margin-bottom: 4px; display: flex; }
        .mode-icon svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 2px; stroke-linecap: round; stroke-linejoin: round; display:block; }
        .mode-label { font-size: 8px; font-weight: 700; text-transform: uppercase; white-space: nowrap; }
        
        .input-area { position: relative; width: 100%; height: 80px; display: flex; align-items: center; justify-content: center; gap: 30px; }
        .action-circle { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-keyboard { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted); }
        .btn-keyboard.active { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-keyboard svg { width: 24px; height: 24px; fill: currentColor; }
        .btn-mic { background: var(--bg-card); border: 2px solid var(--accent); }
        .btn-mic.recording { border-color: var(--danger); background: #330000; box-shadow: 0 0 20px var(--danger); animation: pulseRed 1s infinite; }
        .btn-mic svg { width: 28px; height: 28px; fill: var(--text-main); }
        .btn-mic.recording svg { fill: var(--danger); }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 23, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0); } }

        /* INPUT REMONT√â */
        .text-input-container { 
            position: absolute; bottom: 160px; left: 20px; right: 20px; 
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px);
            border: 1px solid var(--accent); border-radius: 30px; padding: 10px 15px; 
            display: none; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.6); z-index: 60; 
        }
        [data-theme="light"] .text-input-container { background: rgba(255, 255, 255, 0.95); border: 1px solid #ddd; }
        .text-input-container.show { display: flex; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .text-input { flex: 1; background: transparent; border: none; color: white; font-size: 16px; outline: none; }
        [data-theme="light"] .text-input { color: black; }
        .send-btn { background: var(--accent); border: none; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; margin-left: 10px; }
        .ai-feedback { height: 20px; font-size: 12px; color: var(--accent); margin-bottom: 5px; font-weight: bold; }

        /* ONBOARDING */
        .onboarding-overlay, .zen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .onboarding-overlay.show, .zen-overlay.show { display: flex; animation: fadeIn 0.5s; }
        .name-input { background: #222; border: 2px solid #444; color: white; padding: 15px; border-radius: 12px; font-size: 18px; text-align: center; margin-bottom: 20px; outline: none; width: 80%; }
        .save-name-btn { background: var(--accent); color: white; padding: 15px 40px; border-radius: 30px; font-weight: bold; border: none; font-size: 16px; }
        .zen-circle { width: 100px; height: 100px; border-radius: 50%; background: var(--success); box-shadow: 0 0 50px var(--success); margin-bottom: 20px; animation: breathe 4s infinite ease-in-out; }
    </style>
</head>
<body>

    <div id="onboarding-modal" class="onboarding-overlay">
        <div style="font-size:24px; font-weight:900; margin-bottom:20px; color:var(--accent);">Comment t'appelles-tu ?</div>
        <input type="text" id="username-input" class="name-input" placeholder="Ton pr√©nom...">
        <button class="save-name-btn" onclick="saveUsername()">C'est parti !</button>
    </div>

    <div id="zen-popup" class="zen-overlay" onclick="closeZen()">
        <div class="zen-circle"></div><div class="zen-text">ESPRIT LIBRE</div>
    </div>

    <div class="capacity-sidebar">
        <div class="capacity-track"><div id="capacity-bar" class="capacity-fill"></div></div>
    </div>

    <div class="header">
        <div class="header-top">
            <div class="app-logo-container">
                <div class="logo-point-wrapper">
                    <span class="logo-point-ping"></span>
                    <span class="logo-point-solid"></span>
                </div>
                <div class="logo-text">CLARIS</div>
                <div class="version-tag">v3.3</div>
            </div>
            <div class="header-actions">
                <button id="notif-btn" class="header-btn" onclick="requestNotificationPermission()">üîî ON</button>
                <button id="mood-btn" class="header-btn mood-btn active zen" onclick="toggleMood()"><span>üõ°Ô∏è</span> ZEN</button>
                <button id="sound-btn" class="header-btn sound-btn" onclick="togglePinkNoise()"><span>üéß</span> FOCUS</button>
                <button class="header-btn brief-btn" onclick="startMorningBrief()"><span>‚òÄÔ∏è</span> BRIEF</button>
            </div>
        </div>
        <div id="monitor-ui" class="monitor-bar-container">
            <div id="load-bar" class="load-fill"></div>
        </div>
    </div>

    <div class="content-area">
        <div id="view-dump" class="view-section active">
            <div class="task-container" id="task-list"><div style="text-align:center; margin-top:50px; opacity:0.3; font-size:12px;"><p>M√©moire vide.</p></div></div>
        </div>
        <div id="view-calendar" class="view-section">
            <div class="calendar-wrapper">
                <div class="calendar-header">
                    <button class="cal-nav-btn" onclick="changeMonth(-1)">&#8249;</button>
                    <span id="cal-month-label" class="month-label">...</span>
                    <button class="cal-nav-btn" onclick="changeMonth(1)">&#8250;</button>
                </div>
                <div class="calendar-grid">
                    <div class="day-name">L</div><div class="day-name">M</div><div class="day-name">M</div><div class="day-name">J</div><div class="day-name">V</div><div class="day-name">S</div><div class="day-name">D</div>
                    <div id="cal-days-container" style="display:contents"></div>
                </div>
                <div class="calendar-tasks-list"><div class="cal-list-title">T√ÇCHES DU JOUR</div><div id="cal-task-list" class="task-container" style="padding:0;"></div></div>
            </div>
        </div>
        <div id="view-focus" class="view-section">
            <div id="focus-picker-wrapper">
                <div class="focus-title">CHOISIS TA CIBLE</div>
                <div id="focus-grid" class="focus-grid"></div>
            </div>
            <div id="focus-laser-wrapper" class="laser-container">
                <div class="laser-ring-container">
                    <div class="laser-ring"></div>
                    <div class="laser-ring"></div>
                    <div class="laser-ring"></div>
                    <div class="laser-task" id="laser-current-task">...</div>
                </div>
                <div id="laser-ai-suggestion" class="laser-ai-box" style="display:none; color:#AAA; font-size:12px; margin-bottom:15px; border:1px solid #333; padding:10px; border-radius:10px;">
                    <span class="laser-ai-label" style="display:block; font-weight:bold; color:var(--accent); margin-bottom:5px;">PREMI√àRE √âTAPE</span>
                    <span id="laser-micro-text" class="laser-ai-text">...</span>
                </div>
                <button class="laser-btn" onclick="completeLaserTask()">C'EST FAIT</button>
                <button class="laser-back" onclick="exitLaserMode()">Changer de cible</button>
            </div>
        </div>
        <div id="view-routine" class="view-section">
            <div id="routines-grid" class="routine-grid"></div>
            <div id="active-routine-view" class="active-routine-view">
                <div class="routine-header">
                    <button class="back-btn" onclick="exitRoutine()">‚Üê RETOUR</button>
                    <span id="active-routine-name" style="font-weight:bold; color:var(--success); text-transform: uppercase;">...</span>
                    <button class="read-routine-btn" onclick="readActiveRoutine()">üîä LIRE</button>
                </div>
                <div id="routine-steps-list" class="routine-list-scroll"></div>
            </div>
        </div>
        <div id="view-pomo" class="view-section">
            <div class="pomo-container">
                <div class="pomo-timer" id="timer-display">25:00</div>
                <div class="pomo-controls"><button class="pomo-btn btn-stop" onclick="resetTimer()">STOP</button><button class="pomo-btn btn-start" onclick="toggleTimer()" id="btn-timer-action">START</button></div>
            </div>
        </div>
        <div id="view-tuto" class="view-section">
            <div style="padding-bottom: 100px;">
                <h2 style="font-size: 20px; font-weight: 900; margin-bottom: 20px; color:var(--text-main); text-align:center;">MODE D'EMPLOI</h2>
                
                <div class="tuto-card" style="border-left-color: var(--accent);">
                    <div class="tuto-title"><span>üì•</span> CAPTURER</div>
                    <div class="tuto-desc">
                        <p style="margin-bottom:10px;">C'est votre "cerveau externe". √âcrivez ou dictez tout ce qui vous passe par la t√™te. L'assistant trie automatiquement.</p>
                        <p><strong>Code Couleur :</strong></p>
                        <ul style="padding-left:10px; margin-top:5px; font-weight:600;">
                            <li style="color:var(--accent);">üîµ Bleu : T√¢che standard</li>
                            <li style="color:var(--danger);">üî¥ Rouge : T√¢che Urgente</li>
                            <li style="color:var(--calendar);">üü£ Violet : Rendez-vous (Agenda)</li>
                        </ul>
                        <div class="tuto-instruction">üí° Astuce : Dites "Rappeler d'appeler Marc" ou "Urgent : Payer imp√¥ts".</div>
                    </div>
                </div>

                <div class="tuto-card" style="border-left-color: var(--calendar);">
                    <div class="tuto-title"><span>üìÖ</span> CALENDRIER</div>
                    <div class="tuto-desc">
                        <p>Vos rendez-vous avec une heure pr√©cise apparaissent ici et d√©clenchent des rappels.</p>
                        <div class="tuto-instruction">üó£Ô∏è Dites : "Dentiste demain √† 14h00" (Pr√©cisez l'heure pour l'ajouter ici).</div>
                    </div>
                </div>

                <div class="tuto-card" style="border-left-color: var(--warning);">
                    <div class="tuto-title"><span>üéØ</span> FOCUS</div>
                    <div class="tuto-desc">
                        <p>Pour arr√™ter de procrastiner. S√©lectionnez une t√¢che : tout le reste dispara√Æt. <strong>L'assistant</strong> vous propose une premi√®re micro-√©tape pour d√©marrer.</div>
                </div>

                <div class="tuto-card" style="border-left-color: var(--success);">
                    <div class="tuto-title"><span>‚è±Ô∏è</span> POMO</div>
                    <div class="tuto-desc">
                        <p>Timer de concentration. Travaillez 25 minutes √† fond, puis 5 minutes de pause.</p>
                    </div>
                </div>

                <div class="tuto-card" style="border-left-color: #D500F9;">
                    <div class="tuto-title"><span>üîÅ</span> ROUTINE</div>
                    <div class="tuto-desc">
                        <p>Listes r√©utilisables (Matin, Soir, Sport...).</p>
                        <div class="tuto-instruction">üó£Ô∏è Dites : "Cr√©e une routine Matin avec : Douche, Caf√©, M√©ditation".</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-controls">
        <div id="status-text" class="ai-feedback">Pr√™t.</div>
        
        <div class="mode-selector">
            <div class="mode-card active" onclick="switchView('dump', this)">
                <div class="mode-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-6l-2 3h-4l-2-3H2v12h20V12z"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg></div>
                <span class="mode-label">Capturer</span>
            </div>
            <div class="mode-card" onclick="switchView('calendar', this)">
                <div class="mode-icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
                <span class="mode-label">Calendrier</span>
            </div>
            <div class="mode-card" onclick="switchView('focus', this)">
                <div class="mode-icon"><svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
                <span class="mode-label">Focus</span>
            </div>
            <div class="mode-card" onclick="switchView('pomo', this)">
                <div class="mode-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
                <span class="mode-label">Pomo</span>
            </div>
            <div class="mode-card" onclick="switchView('routine', this)">
                <div class="mode-icon"><svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></div>
                <span class="mode-label">Routine</span>
            </div>
            <div class="mode-card" onclick="switchView('tuto', this)">
                <div class="mode-icon"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
                <span class="mode-label">Tuto</span>
            </div>
            <div class="mode-card" onclick="toggleTheme(this)">
                <div class="mode-icon">
                    <svg class="theme-icon-sun" viewBox="0 0 24 24" style="display:block"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </div>
                <span class="mode-label">Th√®me</span>
            </div>
        </div>
        
        <div class="input-area">
            <div class="action-circle btn-keyboard" onclick="toggleInputMode(this)">
                <svg viewBox="0 0 24 24"><path d="M20 5H4c-1.1 0-1.99.9-1.99 2L2 17c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/></svg>
            </div>
            
            <div id="btn-mic" class="action-circle btn-mic" onclick="toggleRecording()">
                <svg id="icon-mic" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                <svg id="icon-stop" viewBox="0 0 24 24" style="display:none"><path d="M6 6h12v12H6z"/></svg>
            </div>
        </div>
        
        <div id="text-input-ui" class="text-input-container">
            <input type="text" id="user-input" class="text-input" placeholder="Quel est ton objectif ?" onkeypress="handleEnter(event)">
            <button class="send-btn" onclick="sendText()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
    </div>

    <script>
        // --- CONSTANTES ---
        const API_BASE_URL = "https://boite-adulte.vercel.app"; 
        const ONESIGNAL_APP_ID = "REMPLACE_PAR_TON_APP_ID_ICI"; 

        // --- THEME MANAGEMENT ---
        function toggleTheme(btn) {
            const current = document.body.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', next);
            localStorage.setItem('claris_theme', next);
            // Animation bouton
            if(btn) {
                btn.style.transform = "scale(0.9)";
                setTimeout(() => btn.style.transform = "scale(1)", 150);
            }
        }

        function loadTheme() {
            const saved = localStorage.getItem('claris_theme');
            if(saved === 'light') {
                document.body.setAttribute('data-theme', 'light');
            }
        }

        // --- INIT ONESIGNAL ---
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        window.OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.init({
                appId: ONESIGNAL_APP_ID,
                notifyButton: { enable: false },
                allowLocalhostAsSecureOrigin: true,
            });
            if(OneSignal.User.PushSubscription.optedIn){
                document.getElementById('notif-btn').classList.add('bell-active');
                document.getElementById('notif-btn').innerText = "üîî ON";
            }
        });

        async function requestNotificationPermission() {
             await OneSignal.User.PushSubscription.optIn();
             const id = OneSignal.User.PushSubscription.id;
             if(id) {
                 document.getElementById('notif-btn').classList.add('bell-active');
                 alert("Notifications activ√©es !");
             }
        }

        // --- PROGRAMMATION NOTIFICATION ---
        async function scheduleNotification(dateObj, message) {
            const userId = OneSignal.User.PushSubscription.id;
            if(!userId) return;
            
            const sendTimeISO = dateObj.toISOString().replace('T', ' ').split('.')[0] + " GMT+0000";

            try { 
                await fetch('/api/schedule-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId, message: message, sendAfter: sendTimeISO })
                });
                // Feedback visuel
                const status = document.getElementById('status-text');
                const oldText = status.innerText;
                status.innerText = "üîî Rappel activ√©";
                status.style.color = "var(--calendar)";
                setTimeout(() => { status.innerText = oldText; status.style.color = "var(--text-main)"; }, 3000);
            } 
            catch (err) { console.error('Erreur Fetch:', err); }
        }

        // --- LOGIQUE PRINCIPALE ---
        let currentMode = 'DUMP';
        let currentMood = 'ZEN';
        let isProcessing = false; isTextMode = false; recognition = null; isRecording = false; finalTranscript = '';
        let timerInterval = null; timeLeft = 25 * 60; isTimerRunning = false;
        let username = "Champion";
        let audioCtx, pinkNoiseNode, gainNode, isNoisePlaying = false;
        let currentFocusTask = null;
        let currentCalDate = new Date();

        document.addEventListener('DOMContentLoaded', () => { 
            loadTheme(); // Charger le th√®me avant tout
            checkOnboarding(); loadTasks(); updateMentalLoad(); updateDailyCapacity(); renderRoutines(); 
            initSpeech(); loadMood(); 
            switchView('dump', document.querySelector('.mode-card.active'));
        });

        function switchView(viewName, btn) {
            document.querySelectorAll('.mode-card').forEach(el => el.classList.remove('active')); if(btn) btn.classList.add('active');
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            const monitor = document.getElementById('monitor-ui');
            if (viewName === 'dump' || viewName === 'focus') monitor.style.opacity = '1'; else monitor.style.opacity = '0';
            currentMode = viewName.toUpperCase();
            if (viewName === 'focus') renderFocusGrid();
            if (viewName === 'calendar') renderCalendar();
            // MAJ STATUS
            const titles = {'dump': "Je note...", 'calendar': "Agenda", 'focus': "Mode Laser", 'routine': "Biblioth√®que", 'pomo': "Timer", 'tuto': "Aide"};
            document.getElementById('status-text').innerText = titles[viewName];
        }

        function togglePinkNoise() { if (isNoisePlaying) stopPinkNoise(); else startPinkNoise(); }
        function startPinkNoise() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const bufferSize = 4096; const pinkNoise = audioCtx.createScriptProcessor(bufferSize, 1, 1);
            var b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
            pinkNoise.onaudioprocess = function(e) {
                var output = e.outputBuffer.getChannelData(0);
                for (var i = 0; i < bufferSize; i++) {
                    var white = Math.random() * 2 - 1;
                    b0 = 0.99886 * b0 + white * 0.0555179; b1 = 0.99332 * b1 + white * 0.0750759; b2 = 0.96900 * b2 + white * 0.1538520; b3 = 0.86650 * b3 + white * 0.3104856; b4 = 0.55000 * b4 + white * 0.5329522; b5 = -0.7616 * b5 - white * 0.0168980; output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362; output[i] *= 0.11; b6 = white * 0.115926;
                }
            };
            const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 400;
            gainNode = audioCtx.createGain(); gainNode.gain.setValueAtTime(0, audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 2);
            pinkNoise.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
            pinkNoiseNode = pinkNoise; isNoisePlaying = true;
            const btn = document.getElementById('sound-btn'); btn.classList.add('active'); btn.innerHTML = `<span>üéß</span> FOCUS <span class="sound-wave"></span>`;
        }
        function stopPinkNoise() {
            if (gainNode) { gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1); setTimeout(() => { if (pinkNoiseNode) { pinkNoiseNode.disconnect(); pinkNoiseNode = null; } isNoisePlaying = false; }, 1000); }
            const btn = document.getElementById('sound-btn'); btn.classList.remove('active'); btn.innerHTML = `<span>üéß</span> FOCUS`;
        }

        function initSpeech() { const Speech = window.SpeechRecognition || window.webkitSpeechRecognition; if (!Speech) return; recognition = new Speech(); recognition.lang = 'fr-FR'; recognition.continuous = true; recognition.interimResults = true; recognition.onresult = (e) => { for (let i = e.resultIndex; i < e.results.length; ++i) { if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript + ' '; } }; recognition.onerror = (e) => { if(e.error === 'not-allowed') stopRecordingState(); }; }
        function toggleRecording() { if (isProcessing) return; if (!isRecording) { finalTranscript = ''; try { recognition.start(); isRecording = true; updateMicVisuals(true); document.getElementById('status-text').innerText = "Enregistrement... (Cliquez pour Stop)"; } catch(e) { recognition.stop(); isRecording = false; } } else { recognition.stop(); isRecording = false; updateMicVisuals(false); document.getElementById('status-text').innerText = "Analyse..."; setTimeout(() => { if (finalTranscript.trim().length > 0) processWithAI(finalTranscript); else document.getElementById('status-text').innerText = "Rien entendu."; }, 800); } }
        function updateMicVisuals(rec) { const btn = document.getElementById('btn-mic'); const micIcon = document.getElementById('icon-mic'); const stopIcon = document.getElementById('icon-stop'); if (rec) { btn.classList.add('recording'); micIcon.style.display = 'none'; stopIcon.style.display = 'block'; } else { btn.classList.remove('recording'); micIcon.style.display = 'block'; stopIcon.style.display = 'none'; } }
        function stopRecordingState() { isRecording = false; updateMicVisuals(false); document.getElementById('status-text').innerText = "Erreur Micro"; }

        // --- IA PROCESS ---
        async function processWithAI(userInput) {
            isProcessing = true; document.getElementById('status-text').innerText = "R√©fl√©chit..."; 
            const lowerInput = userInput.toLowerCase();
            let forcedMode = currentMode;
            if (lowerInput.includes("routine") || lowerInput.includes("cr√©e une routine")) { forcedMode = 'ROUTINE'; }
            
            const currentPrompts = getPrompts(); 
            const finalPrompt = `${currentPrompts[forcedMode]}\n\nUTILISATEUR : "${userInput}"`;
            try {
                const rep = await fetch('/api/gemini', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: finalPrompt }) });
                const data = await rep.json();
                let parsed = JSON.parse(data.text.replace(/```json/g, '').replace(/```/g, '').trim());
                
                if (parsed.command === 'SAVE_ROUTINE') { saveRoutine(parsed.name, parsed.steps); playVocalResponse(`Routine ${parsed.name} enregistr√©e.`); switchView('routine', document.querySelectorAll('.mode-card')[4]); isProcessing = false; return; }
                else if (parsed.command === 'GET_ROUTINE') { const savedSteps = JSON.parse(localStorage.getItem('neuro_routines') || '{}')[parsed.name.toLowerCase()]; if (savedSteps) { switchView('routine', document.querySelectorAll('.mode-card')[4]); launchRoutine(parsed.name); playVocalResponse(`Voici ta routine.`); } else { playVocalResponse(`Routine inconnue.`); } isProcessing = false; return; }
                
                let actionsList = parsed.actions;
                if (!actionsList && parsed.type) { actionsList = [parsed]; }
                
                if(actionsList) { 
                    actionsList.forEach(act => { 
                        const validText = act.detail || act.text || act.task || act.title || "T√¢che";
                        
                        if (act.time && act.due_date) {
                            const targetDateStr = `${act.due_date}T${act.time}:00`;
                            const targetDate = new Date(targetDateStr);
                            const now = new Date();
                            if (targetDate > now) {
                                scheduleNotification(targetDate, `Rappel CLARIS : ${validText}`);
                            }
                        }

                        addTaskToUI(validText, act.type, act.priority || 'NORMAL', act.duration, act.due_date, act.time); 
                    }); 
                }
                playVocalResponse(parsed.text);
            } catch (e) { console.error(e); document.getElementById('status-text').innerText = "Erreur"; isProcessing = false; }
        }

        function addTaskToUI(text, type, priority='NORMAL', duration=15, date=null, time=null) {
            const list = document.getElementById('task-list');
            if(list.innerText.includes("M√©moire vide")) list.innerHTML = "";
            const div = document.createElement('div');
            const isCal = (type === 'CALENDAR'); const isRem = (type === 'REMINDER'); const isHigh = (priority === 'HIGH');
            
            div.className = `task-item ${isCal ? 'calendar' : ''} ${isRem ? 'reminder' : ''} ${isHigh ? 'priority-high' : ''}`;
            div.setAttribute('data-duration', duration);
            if(date) div.setAttribute('data-date', date);
            
            const syncIcon = isCal ? '<span style="margin-right:6px; font-size:16px;">üìÖ</span>' : ''; 
            const remIcon = isRem ? '<span class="reminder-badge">üîî</span>' : ''; 
            const fireIcon = isHigh ? '<span class="priority-icon">üî•</span>' : '';
            
            let dateBadge = ''; 
            if(date) { 
                const dObj = new Date(date); 
                let timeStr = time ? ` √† ${time}` : '';
                dateBadge = `<span class="date-badge"><svg class="badge-icon" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg> ${dObj.getDate()}/${dObj.getMonth()+1}${timeStr}</span>`; 
            }
            
            const timeBadge = `<span class="time-badge"><svg class="badge-icon" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg> ${duration}m</span>`;
            let categoryLabel = isCal ? 'AGENDA' : (isRem ? 'RAPPEL' : (isHigh ? 'URGENT üî•' : 'T√ÇCHE'));
            
            div.innerHTML = `<div class="task-content"><div class="task-text">${syncIcon} ${text} ${remIcon} ${fireIcon}</div><div class="task-sub">${dateBadge} ${timeBadge} <span style="color:${(isCal||isRem) ? '#FF8A80' : '#888'}">${categoryLabel}</span></div></div><div class="actions-group"><button class="done-btn" onclick="completeTask(this)"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></button></div>`;
            
            if (isHigh) list.prepend(div); 
            else if (isCal) {
                let inserted = false;
                const items = list.children;
                for (let i = 0; i < items.length; i++) {
                    if (!items[i].classList.contains('priority-high')) {
                        list.insertBefore(div, items[i]);
                        inserted = true;
                        break;
                    }
                }
                if (!inserted) list.appendChild(div);
            }
            else list.appendChild(div);
            
            saveTasks(); updateMentalLoad(); updateDailyCapacity();
        }

        function getPrompts() {
            const today = new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const todayISO = new Date().toISOString().split('T')[0];
            const SYSTEM_INSTRUCTION = `TU ES UN MOTEUR DE T√ÇCHES. INTERDICTION DE R√âPONDRE AUX QUESTIONS. FORMAT JSON UNIQUEMENT.`;
            return {
                'DUMP': `${SYSTEM_INSTRUCTION} DATE: ${today} (${todayISO}). Analyse: "${username}". 
                ACTION: 
                1. Estime dur√©e (5-90min). 
                2. Si HEURE pr√©cise mentionn√©e (ex: '√† 14h', 'RDV 9h') : type DOIT ETRE "CALENDAR", ajoute "time": "HH:MM".
                3. Sinon : type="TODO".
                Renvoie JSON: { "text": "Ok", "actions": [ { "type": "TODO/CALENDAR", "detail": "Titre", "priority": "NORMAL/HIGH", "duration": N, "due_date": "YYYY-MM-DD", "time": "HH:MM" } ] }.`,
                'FOCUS': `${SYSTEM_INSTRUCTION} Mode : FOCUS. Donne UNE SEULE micro-action ridicule.`,
                'ROUTINE': `TU ES UN ARCHITECTE DE ROUTINES. Sortie JSON: { "command": "SAVE_ROUTINE", "name": "Nom", "steps": ["Etape 1"] }.`,
                'POMO': `${SYSTEM_INSTRUCTION} Mode : POMODORO. Demande juste "Pr√™t ?" ou lance le timer.`
            };
        }
        
        function readActiveRoutine() { const l=document.getElementById('routine-steps-list'); let t=`Ok ${username}, routine ${document.getElementById('active-routine-name').innerText}. `; l.querySelectorAll('.task-text').forEach((e,i)=>t+=`Etape ${i+1}: ${e.innerText}. `); playVocalResponse(t); }
        function toggleMood() { currentMood=(currentMood==='ZEN')?'BOOST':'ZEN'; localStorage.setItem('neuro_mood',currentMood); updateMoodUI(); }
        function updateMoodUI() { const b=document.getElementById('mood-btn'); b.className=`header-btn mood-btn active ${currentMood.toLowerCase()}`; b.innerHTML=(currentMood==='ZEN')?"<span>üõ°Ô∏è</span> ZEN":"<span>üöÄ</span> BOOST"; }
        function loadMood() { const s=localStorage.getItem('neuro_mood'); if(s){currentMood=s;updateMoodUI();} }
        function completeTask(b) { const i=b.closest('.task-item'); i.style.transform="translateX(100%)"; i.style.opacity="0"; setTimeout(()=>{i.remove();saveTasks();updateMentalLoad();updateDailyCapacity();},300); }
        function saveTasks() { localStorage.setItem('neuro_tasks',document.getElementById('task-list').innerHTML); }
        function loadTasks() { const s=localStorage.getItem('neuro_tasks'); if(s&&s.trim()!="")document.getElementById('task-list').innerHTML=s; }
        function updateMentalLoad() { const i=document.querySelectorAll('#task-list .task-item'); let s=0; i.forEach(e=>s+=(e.classList.contains('priority-high')?3:1)); document.getElementById('load-bar').style.width=Math.min((s/12)*100,100)+"%"; }
        function updateDailyCapacity() { const i=document.querySelectorAll('#task-list .task-item'); let m=0; i.forEach(e=>m+=parseInt(e.getAttribute('data-duration'))||15); document.getElementById('capacity-bar').style.height=Math.min((m/360)*100,100)+"%"; }
        function checkOnboarding() { const n=localStorage.getItem('neuro_username'); if(n)username=n; else document.getElementById('onboarding-modal').classList.add('show'); }
        function saveUsername() { const i=document.getElementById('username-input'); if(i.value.trim()){username=i.value.trim();localStorage.setItem('neuro_username',username);document.getElementById('onboarding-modal').classList.remove('show');} }
        function cleanTextForSpeech(t) { if(!t)return""; return t.replace(/[*#]/g,'').replace(/^- /g,''); }
        async function playVocalResponse(t) { document.getElementById('status-text').innerText="Pr√™t."; isProcessing=false; window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(cleanTextForSpeech(t)); u.lang='fr-FR'; u.rate=(currentMood==='ZEN')?0.85:1.1; window.speechSynthesis.speak(u); }
        function getRoutineStyle(n) { const x=n.toLowerCase(); if(x.includes('matin'))return{icon:'‚òÄÔ∏è',color:'#FFD740',bg:'rgba(255,215,64,0.1)'}; if(x.includes('soir'))return{icon:'üåô',color:'#536DFE',bg:'rgba(83,109,254,0.1)'}; if(x.includes('sport'))return{icon:'üí™',color:'#FF4081',bg:'rgba(255,64,129,0.1)'}; return{icon:'‚ö°',color:'#BB86FC',bg:'rgba(187,134,252,0.1)'}; }
        function saveRoutine(n,s) { let r=JSON.parse(localStorage.getItem('neuro_routines')||'{}'); r[n.toLowerCase()]=s; localStorage.setItem('neuro_routines',JSON.stringify(r)); renderRoutines(); }
        function deleteRoutine(n,e) { e.stopPropagation(); if(confirm("Supprimer?")){ let r=JSON.parse(localStorage.getItem('neuro_routines')||'{}'); delete r[n]; localStorage.setItem('neuro_routines',JSON.stringify(r)); renderRoutines(); } }
        function deleteStepFromRoutine(n,i) { let r=JSON.parse(localStorage.getItem('neuro_routines')||'{}'); const k=Object.keys(r).find(x=>x===n.toLowerCase()); if(k){r[k].splice(i,1); localStorage.setItem('neuro_routines',JSON.stringify(r)); launchRoutine(n);} }
        function renderRoutines() { const g=document.getElementById('routines-grid'); const r=JSON.parse(localStorage.getItem('neuro_routines')||'{}'); g.innerHTML=""; for(let k in r){ const d=document.createElement('div'); d.className='routine-card-item'; const s=getRoutineStyle(k); d.style.borderLeft=`4px solid ${s.color}`; d.style.background=`linear-gradient(135deg, ${s.bg}, var(--bg-card))`; d.innerHTML=`<span class='routine-icon'>${s.icon}</span><span class='routine-name'>${k}</span><div class="routine-delete-btn" onclick="deleteRoutine('${k}',event)">‚úï</div>`; d.onclick=()=>launchRoutine(k); g.appendChild(d); } }
        function launchRoutine(n) { const r=JSON.parse(localStorage.getItem('neuro_routines')||'{}'); const s=r[n.toLowerCase()]; if(!s)return; document.getElementById('routines-grid').style.display='none'; document.getElementById('active-routine-view').style.display='flex'; document.getElementById('active-routine-name').innerText=n; const l=document.getElementById('routine-steps-list'); l.innerHTML=""; s.forEach((x,i)=>{ const d=document.createElement('div'); d.className="routine-step-item"; d.innerHTML=`<div class="routine-step-text">${x}</div><div class="actions-group"><button class="delete-step-btn" onclick="deleteStepFromRoutine('${n}',${i})">X</button><button class="done-btn" onclick="this.parentElement.parentElement.remove();checkRoutineFinish()">V</button></div>`; l.appendChild(d); }); }
        function checkRoutineFinish() { if(document.getElementById('routine-steps-list').children.length===0){playVocalResponse("Termin√©!");exitRoutine();} }
        function exitRoutine() { document.getElementById('routines-grid').style.display='grid'; document.getElementById('active-routine-view').style.display='none'; }
        function renderCalendar() { const c=document.getElementById('cal-days-container'); const m=document.getElementById('cal-month-label'); const y=currentCalDate.getFullYear(); const mo=currentCalDate.getMonth(); m.innerText=["Jan","F√©v","Mar","Avr","Mai","Juin","Juil","Ao√ª","Sep","Oct","Nov","D√©c"][mo]+" "+y; c.innerHTML=""; const f=new Date(y,mo,1).getDay(); const d=new Date(y,mo+1,0).getDate(); const o=(f===0)?6:f-1; for(let i=0;i<o;i++)c.appendChild(document.createElement('div')); const t=[]; document.querySelectorAll('.task-item').forEach(i=>{if(i.getAttribute('data-date'))t.push({d:i.getAttribute('data-date'),h:i.outerHTML});}); for(let i=1;i<=d;i++){ const e=document.createElement('div'); e.className="day-cell"; e.innerText=i; const ds=`${y}-${String(mo+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; if(new Date().toDateString()===new Date(y,mo,i).toDateString())e.classList.add('today'); if(t.some(x=>x.d===ds))e.classList.add('has-task'); e.onclick=()=>{document.querySelectorAll('.day-cell').forEach(x=>x.classList.remove('selected'));e.classList.add('selected');showTasksForDay(t.filter(x=>x.d===ds),i);}; c.appendChild(e); } }
        function changeMonth(d) { currentCalDate.setMonth(currentCalDate.getMonth()+d); renderCalendar(); }
        function showTasksForDay(t,d) { const l=document.getElementById('cal-task-list'); if(t.length===0)l.innerHTML=`<div style="text-align:center; opacity:0.5; font-size:12px;">Rien de pr√©vu le ${d}.</div>`; else { l.innerHTML=""; t.forEach(x=>{const d=document.createElement('div');d.innerHTML=x.h;if(d.querySelector('.done-btn'))d.querySelector('.done-btn').style.display='none';l.appendChild(d.firstChild);}); } }
        function renderFocusGrid() { const g=document.getElementById('focus-grid'); const h=document.getElementById('task-list').innerHTML; document.getElementById('focus-picker-wrapper').style.display='block'; document.getElementById('focus-laser-wrapper').style.display='none'; if(h.includes("M√©moire vide")){g.innerHTML=`<div style="text-align:center; opacity:0.5; margin-top:40px;">Rien.</div>`;return;} g.innerHTML=""; const t=document.createElement('div'); t.innerHTML=h; t.querySelectorAll('.task-item').forEach(i=>{ const txt=i.querySelector('.task-text').innerText; const d=document.createElement('div'); d.className="focus-chip"; d.innerHTML=`<span class="focus-chip-text">${txt}</span><div class="focus-chip-action">‚ñ∂</div>`; d.onclick=()=>activateLaserMode(txt); g.appendChild(d); }); }
        async function activateLaserMode(t) { currentFocusTask=t; document.getElementById('focus-picker-wrapper').style.display='none'; document.getElementById('focus-laser-wrapper').style.display='flex'; document.getElementById('laser-current-task').innerText=t; document.getElementById('laser-ai-suggestion').style.display='none'; document.getElementById('status-text').innerText="Analyse..."; try{const p=`Coach. T√¢che: "${t}". Une micro-√©tape.`; const r=await fetch('/api/gemini',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:p})}); const d=await r.json(); document.getElementById('laser-micro-text').innerText=d.text.replace(/\*/g,''); document.getElementById('laser-ai-suggestion').style.display='block'; playVocalResponse(`Cible: ${d.text}`);}catch(e){} }
        function completeLaserTask() { triggerConfetti(); playVocalResponse("Bravo!"); const l=document.getElementById('task-list'); l.querySelectorAll('.task-item').forEach(i=>{if(i.querySelector('.task-text').innerText.includes(currentFocusTask))i.remove();}); saveTasks(); updateMentalLoad(); updateDailyCapacity(); setTimeout(exitLaserMode,2000); }
        function exitLaserMode() { document.getElementById('focus-laser-wrapper').style.display='none'; document.getElementById('focus-picker-wrapper').style.display='block'; renderFocusGrid(); }
        function toggleInputMode(b) { isTextMode=!isTextMode; const u=document.getElementById('text-input-ui'); if(isTextMode){u.classList.add('show');b.classList.add('active');document.getElementById('user-input').focus();}else{u.classList.remove('show');b.classList.remove('active');} }
        function handleEnter(e) { if(e.key==='Enter')sendText(); }
        function sendText() { const i=document.getElementById('user-input'); if(i.value.trim()){processWithAI(i.value);i.value="";} }
        function updateTimerDisplay() { document.getElementById('timer-display').innerText=`${Math.floor(timeLeft/60).toString().padStart(2,'0')}:${(timeLeft%60).toString().padStart(2,'0')}`; }
        
        function toggleTimer() { 
            const b=document.getElementById('btn-timer-action'); 
            if(isTimerRunning){
                clearInterval(timerInterval);
                isTimerRunning=false;
                b.innerText="REPRENDRE";
            } else {
                timerInterval=setInterval(()=>{timeLeft--;updateTimerDisplay();if(timeLeft<=0){clearInterval(timerInterval);playVocalResponse("Fini!");triggerConfetti();}},1000);
                isTimerRunning=true;
                b.innerText="PAUSE";
                // PROGRAMMER LA NOTIF
                const mins = Math.ceil(timeLeft / 60);
                // Calculer la date de fin pour l'envoyer au backend
                const endDate = new Date();
                endDate.setMinutes(endDate.getMinutes() + mins);
                scheduleNotification(endDate, "Session termin√©e !");
            } 
        }

        function resetTimer() { clearInterval(timerInterval);isTimerRunning=false;timeLeft=25*60;updateTimerDisplay(); }
        function closeZen() { document.getElementById('zen-popup').classList.remove('show'); }
        function triggerConfetti() { confetti({particleCount:100,spread:70,origin:{y:0.6}}); }
        async function startMorningBrief() { if(isProcessing)return; isProcessing=true; document.getElementById('status-text').innerText="Brief..."; const b=document.querySelector('.brief-btn'); b.classList.add('loading'); const l=[]; document.querySelectorAll('#task-list .task-text').forEach(e=>l.push(e.innerText)); const p=`Date: ${new Date().toLocaleDateString()}. T√¢ches: ${l.join(", ")}. Brief 30s. Bonjour ${username}.`; try{const r=await fetch('/api/gemini',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:p})}); const d=await r.json(); playVocalResponse(d.text);}catch(e){} b.classList.remove('loading'); isProcessing=false; }
        function stopThinkingAnimation() { }

        // --- ENREGISTREMENT PWA (SERVICE WORKER) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // On enregistre sw.js (qui s'occupe de l'offline)
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('Erreur SW', err));
                // OneSignal enregistre son propre worker automatiquement via le script OneSignalSDKWorker.js
            });
        }
    </script>
</body>
</html>